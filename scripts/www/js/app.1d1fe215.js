(function(){"use strict";var t={8076:function(t,e,s){var i=s(5471),a=function(){var t=this,e=t._self._c;return e("div",{attrs:{id:"app"}},[e("div",{ref:"page",staticClass:"page",class:{"page--consult":"/consult"===t.$route.path}},[e("router-view")],1),e("div",{staticClass:"tabbar"},[e("div",{staticClass:"tab-item",class:{"tab-item--active":"/consult"===t.$route.path},on:{click:function(e){return t.$router.replace("/consult")}}},[e("svg",{staticClass:"tab-icon",attrs:{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"}},[e("path",{attrs:{d:"M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"}}),e("polyline",{attrs:{points:"9 22 9 12 15 12 15 22"}})]),e("div",{staticClass:"tab-text"},[t._v("AI助手")])]),e("div",{staticClass:"tab-item",class:{"tab-item--active":"/message"===t.$route.path},on:{click:function(e){return t.$router.replace("/message")}}},[e("div",{staticClass:"tab-icon-wrap"},[e("svg",{staticClass:"tab-icon",attrs:{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"}},[e("path",{attrs:{d:"M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"}}),e("path",{attrs:{d:"M13.73 21a2 2 0 0 1-3.46 0"}})]),t.unreadCount>0?e("span",{staticClass:"tab-badge"},[t._v(t._s(t.unreadCount>99?"99+":t.unreadCount))]):t._e()]),e("div",{staticClass:"tab-text"},[t._v("消息")])]),e("div",{staticClass:"tab-item",class:{"tab-item--active":"/mine"===t.$route.path},on:{click:function(e){return t.$router.replace("/mine")}}},[e("svg",{staticClass:"tab-icon",attrs:{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"}},[e("path",{attrs:{d:"M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"}}),e("circle",{attrs:{cx:"12",cy:"7",r:"4"}})]),e("div",{staticClass:"tab-text"},[t._v("我的")])])])])},n=[],r={name:"App",data(){return{unreadCount:2}},watch:{$route(){this.$nextTick(()=>{const t=this.$refs.page;t&&"number"===typeof t.scrollTop&&(t.scrollTop=0)})}}},o=r,l=s(1656),c=(0,l.A)(o,a,n,!1,null,null,null),d=c.exports,u=s(173),h=(s(4114),function(){var t=this,e=t._self._c;return e("div",{staticClass:"page"},[e("header",{staticClass:"header"},[e("button",{staticClass:"back-btn",on:{click:function(e){return t.$router.back()}}},[e("svg",{attrs:{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"}},[e("path",{attrs:{d:"M15 18l-6-6 6-6"}})])]),e("h1",{staticClass:"title"},[t._v("全部应用")]),e("div",{staticClass:"placeholder"})]),e("section",{staticClass:"section"},[t._m(0),e("div",{staticClass:"app-grid"},[e("div",{staticClass:"app-item",on:{click:function(e){return t.$router.push("/consult")}}},[e("div",{staticClass:"app-icon blue"},[e("svg",{attrs:{width:"22",height:"22",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"1.5"}},[e("path",{attrs:{d:"M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"}})])]),e("span",{staticClass:"app-name"},[t._v("AI 助手")])]),e("div",{staticClass:"app-item",on:{click:function(e){return t.goTo("risk")}}},[e("div",{staticClass:"app-icon red"},[e("svg",{attrs:{width:"22",height:"22",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"1.5"}},[e("path",{attrs:{d:"M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"}})])]),e("span",{staticClass:"app-name"},[t._v("风险中心")])]),e("div",{staticClass:"app-item",on:{click:function(e){return t.goTo("bill")}}},[e("div",{staticClass:"app-icon teal"},[e("svg",{attrs:{width:"22",height:"22",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"1.5"}},[e("path",{attrs:{d:"M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"}}),e("polyline",{attrs:{points:"14 2 14 8 20 8"}})])]),e("span",{staticClass:"app-name"},[t._v("票据管理")])])])]),e("section",{staticClass:"section"},[t._m(1),e("div",{staticClass:"app-grid"},[e("div",{staticClass:"app-item",on:{click:function(e){return t.goTo("invoice")}}},[e("div",{staticClass:"app-icon orange"},[e("svg",{attrs:{width:"22",height:"22",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"1.5"}},[e("rect",{attrs:{x:"3",y:"4",width:"18",height:"18",rx:"2",ry:"2"}}),e("line",{attrs:{x1:"16",y1:"2",x2:"16",y2:"6"}}),e("line",{attrs:{x1:"8",y1:"2",x2:"8",y2:"6"}}),e("line",{attrs:{x1:"3",y1:"10",x2:"21",y2:"10"}})])]),e("span",{staticClass:"app-name"},[t._v("发票识别")])]),e("div",{staticClass:"app-item",on:{click:function(e){return t.goTo("tax")}}},[e("div",{staticClass:"app-icon green"},[e("svg",{attrs:{width:"22",height:"22",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"1.5"}},[e("rect",{attrs:{x:"4",y:"2",width:"16",height:"20",rx:"2"}}),e("line",{attrs:{x1:"8",y1:"6",x2:"16",y2:"6"}}),e("line",{attrs:{x1:"8",y1:"10",x2:"10",y2:"10"}}),e("line",{attrs:{x1:"14",y1:"10",x2:"16",y2:"10"}}),e("line",{attrs:{x1:"8",y1:"14",x2:"10",y2:"14"}}),e("line",{attrs:{x1:"14",y1:"14",x2:"16",y2:"14"}}),e("line",{attrs:{x1:"8",y1:"18",x2:"16",y2:"18"}})])]),e("span",{staticClass:"app-name"},[t._v("税务计算")])]),e("div",{staticClass:"app-item",on:{click:function(e){return t.goTo("report")}}},[e("div",{staticClass:"app-icon purple"},[e("svg",{attrs:{width:"22",height:"22",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"1.5"}},[e("line",{attrs:{x1:"18",y1:"20",x2:"18",y2:"10"}}),e("line",{attrs:{x1:"12",y1:"20",x2:"12",y2:"4"}}),e("line",{attrs:{x1:"6",y1:"20",x2:"6",y2:"14"}})])]),e("span",{staticClass:"app-name"},[t._v("数据报表")])]),e("div",{staticClass:"app-item",on:{click:function(e){return t.goTo("reconcile")}}},[e("div",{staticClass:"app-icon indigo"},[e("svg",{attrs:{width:"22",height:"22",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"1.5"}},[e("rect",{attrs:{x:"1",y:"4",width:"22",height:"16",rx:"2",ry:"2"}}),e("line",{attrs:{x1:"1",y1:"10",x2:"23",y2:"10"}})])]),e("span",{staticClass:"app-name"},[t._v("银行对账")])])])]),e("section",{staticClass:"section"},[t._m(2),e("div",{staticClass:"app-grid"},[e("div",{staticClass:"app-item",on:{click:function(e){return t.goTo("analysis")}}},[e("div",{staticClass:"app-icon cyan"},[e("svg",{attrs:{width:"22",height:"22",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"1.5"}},[e("polyline",{attrs:{points:"23 6 13.5 15.5 8.5 10.5 1 18"}}),e("polyline",{attrs:{points:"17 6 23 6 23 12"}})])]),e("span",{staticClass:"app-name"},[t._v("趋势分析")])]),e("div",{staticClass:"app-item",on:{click:function(e){return t.goTo("compare")}}},[e("div",{staticClass:"app-icon pink"},[e("svg",{attrs:{width:"22",height:"22",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"1.5"}},[e("path",{attrs:{d:"M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"}}),e("polyline",{attrs:{points:"14 2 14 8 20 8"}}),e("line",{attrs:{x1:"16",y1:"13",x2:"8",y2:"13"}}),e("line",{attrs:{x1:"16",y1:"17",x2:"8",y2:"17"}})])]),e("span",{staticClass:"app-name"},[t._v("智能报告")])]),e("div",{staticClass:"app-item",on:{click:function(e){return t.goTo("export")}}},[e("div",{staticClass:"app-icon amber"},[e("svg",{attrs:{width:"22",height:"22",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"1.5"}},[e("path",{attrs:{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"}}),e("polyline",{attrs:{points:"7 10 12 15 17 10"}}),e("line",{attrs:{x1:"12",y1:"15",x2:"12",y2:"3"}})])]),e("span",{staticClass:"app-name"},[t._v("数据导出")])])])]),e("section",{staticClass:"section last"},[t._m(3),e("div",{staticClass:"app-grid"},[e("div",{staticClass:"app-item",on:{click:function(e){return t.goTo("warning")}}},[e("div",{staticClass:"app-icon rose"},[e("svg",{attrs:{width:"22",height:"22",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"1.5"}},[e("path",{attrs:{d:"M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"}}),e("line",{attrs:{x1:"12",y1:"9",x2:"12",y2:"13"}}),e("line",{attrs:{x1:"12",y1:"17",x2:"12.01",y2:"17"}})])]),e("span",{staticClass:"app-name"},[t._v("风险预警")]),e("span",{staticClass:"app-badge"},[t._v("2")])]),e("div",{staticClass:"app-item",on:{click:function(e){return t.goTo("audit")}}},[e("div",{staticClass:"app-icon emerald"},[e("svg",{attrs:{width:"22",height:"22",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"1.5"}},[e("path",{attrs:{d:"M22 11.08V12a10 10 0 1 1-5.93-9.14"}}),e("polyline",{attrs:{points:"22 4 12 14.01 9 11.01"}})])]),e("span",{staticClass:"app-name"},[t._v("合规检查")])]),e("div",{staticClass:"app-item",on:{click:function(e){return t.goTo("trace")}}},[e("div",{staticClass:"app-icon slate"},[e("svg",{attrs:{width:"22",height:"22",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"1.5"}},[e("circle",{attrs:{cx:"11",cy:"11",r:"8"}}),e("line",{attrs:{x1:"21",y1:"21",x2:"16.65",y2:"16.65"}})])]),e("span",{staticClass:"app-name"},[t._v("异常检测")])])])])])}),p=[function(){var t=this,e=t._self._c;return e("div",{staticClass:"section-head"},[e("h3",[t._v("常用")])])},function(){var t=this,e=t._self._c;return e("div",{staticClass:"section-head"},[e("h3",[t._v("财务工具")])])},function(){var t=this,e=t._self._c;return e("div",{staticClass:"section-head"},[e("h3",[t._v("数据分析")])])},function(){var t=this,e=t._self._c;return e("div",{staticClass:"section-head"},[e("h3",[t._v("风险管理")])])}],m={name:"AppsPage",methods:{goTo(t){console.log("跳转到:",t)}}},g=m,v=(0,l.A)(g,h,p,!1,null,"072e1429",null),f=v.exports,C=function(){var t=this,e=t._self._c;return e("div",{staticClass:"message-page"},[e("div",{staticClass:"fixed-header"},[e("div",{staticClass:"top-section"},[e("div",{staticClass:"top-bg"}),e("div",{staticClass:"overview"},[e("div",{staticClass:"overview-item",on:{click:function(e){t.currentTab="unread"}}},[e("div",{staticClass:"overview-num",class:{highlight:t.unreadCount>0}},[t._v(t._s(t.unreadCount))]),e("div",{staticClass:"overview-label"},[t._v("未读消息")])]),e("div",{staticClass:"overview-divider"}),e("div",{staticClass:"overview-item",on:{click:function(e){t.currentTab="risk"}}},[e("div",{staticClass:"overview-num warning"},[t._v(t._s(t.riskCount))]),e("div",{staticClass:"overview-label"},[t._v("风险提醒")])]),e("div",{staticClass:"overview-divider"}),e("div",{staticClass:"overview-item",on:{click:function(e){t.currentTab="all"}}},[e("div",{staticClass:"overview-num"},[t._v(t._s(t.totalCount))]),e("div",{staticClass:"overview-label"},[t._v("全部消息")])])])]),e("div",{staticClass:"tabs-wrapper"},[e("div",{staticClass:"tabs"},t._l(t.tabs,function(s){return e("button",{key:s.key,staticClass:"tab",class:{active:t.currentTab===s.key},on:{click:function(e){t.currentTab=s.key}}},[t._v(t._s(s.label))])}),0),t.unreadCount>0?e("button",{staticClass:"read-all",on:{click:t.markAllRead}},[t._v(" 全部已读 ")]):t._e()])]),e("div",{staticClass:"list-section"},[0===t.filteredItems.length?e("div",{staticClass:"empty"},[e("div",{staticClass:"empty-circle"},[e("svg",{attrs:{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"1.5"}},[e("path",{attrs:{d:"M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"}}),e("path",{attrs:{d:"M13.73 21a2 2 0 0 1-3.46 0"}})])]),e("div",{staticClass:"empty-text"},[t._v("暂无消息")])]):e("div",{staticClass:"msg-list"},t._l(t.filteredItems,function(s,i){return e("div",{key:i,staticClass:"msg-item",class:{unread:!s.read},on:{click:function(e){return t.openMessage(s)}}},[e("div",{staticClass:"msg-icon",class:s.level},["high"===s.level?e("svg",{attrs:{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"}},[e("path",{attrs:{d:"M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"}}),e("line",{attrs:{x1:"12",y1:"9",x2:"12",y2:"13"}}),e("line",{attrs:{x1:"12",y1:"17",x2:"12.01",y2:"17"}})]):"mid"===s.level?e("svg",{attrs:{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"}},[e("circle",{attrs:{cx:"12",cy:"12",r:"10"}}),e("line",{attrs:{x1:"12",y1:"8",x2:"12",y2:"12"}}),e("line",{attrs:{x1:"12",y1:"16",x2:"12.01",y2:"16"}})]):e("svg",{attrs:{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"}},[e("path",{attrs:{d:"M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"}}),e("path",{attrs:{d:"M13.73 21a2 2 0 0 1-3.46 0"}})])]),e("div",{staticClass:"msg-body"},[e("div",{staticClass:"msg-header"},[e("span",{staticClass:"msg-tag",class:s.level},[t._v(t._s(s.levelText))]),e("span",{staticClass:"msg-time"},[t._v(t._s(s.time))])]),e("div",{staticClass:"msg-title"},[t._v(t._s(s.title))]),e("div",{staticClass:"msg-desc"},[t._v(t._s(s.desc))])]),s.read?t._e():e("div",{staticClass:"msg-dot"})])}),0)])])},y=[],k=(s(8111),s(2489),s(1701),s(8335),s(7588),s(3110),s(4603),s(7566),s(8721),s(4335));const w=k.A.create({baseURL:"http://192.168.3.135:50002",timeout:6e4});let b=!1,x=null,S=null,_=null;function I(){if(S)return;const t=document.createElement("style");t.type="text/css",t.textContent="\n  .login-prompt-mask{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(15,23,42,.45);z-index:9999;backdrop-filter:saturate(180%) blur(10px);}\n  .login-prompt-card{width:min(360px,calc(100vw - 40px));border-radius:18px;background:rgba(255,255,255,.92);box-shadow:0 20px 60px rgba(15,23,42,.25);border:1px solid rgba(226,232,240,.85);overflow:hidden;transform:translateY(8px) scale(.98);opacity:0;transition:all .18s ease;}\n  .login-prompt-card.show{transform:translateY(0) scale(1);opacity:1;}\n  .login-prompt-top{padding:18px 18px 10px;display:flex;gap:12px;align-items:flex-start;}\n  .login-prompt-icon{width:42px;height:42px;border-radius:14px;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,rgba(59,130,246,.16),rgba(37,99,235,.10));color:#2563eb;flex-shrink:0;}\n  .login-prompt-title{font-size:15px;font-weight:800;color:#0f172a;line-height:1.3;margin:1px 0 6px;}\n  .login-prompt-desc{font-size:13px;color:#475569;line-height:1.6;}\n  .login-prompt-actions{display:flex;gap:10px;padding:14px 18px 18px;}\n  .login-prompt-btn{flex:1;height:42px;border-radius:12px;border:1px solid rgba(226,232,240,.9);font-size:13px;font-weight:800;cursor:pointer;}\n  .login-prompt-btn.secondary{background:rgba(248,250,252,.9);color:#334155;}\n  .login-prompt-btn.primary{border:none;background:linear-gradient(135deg,#3b82f6 0%,#2563eb 100%);color:#fff;box-shadow:0 10px 24px rgba(37,99,235,.25);}\n  .login-prompt-btn:active{transform:scale(.99);}\n  ",document.head.appendChild(t),S=t}function T(){x&&x.parentNode&&x.parentNode.removeChild(x),x=null,_=null}function M(t){return _||("undefined"===typeof document?Promise.resolve(!0):(I(),_=new Promise(e=>{const s=document.createElement("div");s.className="login-prompt-mask";const i=document.createElement("div");i.className="login-prompt-card";const a=document.createElement("div");a.className="login-prompt-top";const n=document.createElement("div");n.className="login-prompt-icon",n.innerHTML='<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:22px;height:22px"><path d="M12 9v4"/><path d="M12 17h.01"/><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/></svg>';const r=document.createElement("div"),o=document.createElement("div");o.className="login-prompt-title",o.textContent="需要登录";const l=document.createElement("div");l.className="login-prompt-desc",l.textContent=t||"该功能需要先登录，登录成功后将自动继续。",r.appendChild(o),r.appendChild(l),a.appendChild(n),a.appendChild(r);const c=document.createElement("div");c.className="login-prompt-actions";const d=document.createElement("button");d.type="button",d.className="login-prompt-btn secondary",d.textContent="稍后";const u=document.createElement("button");u.type="button",u.className="login-prompt-btn primary",u.textContent="去登录";const h=t=>{T(),e(t)};d.onclick=()=>h(!1),u.onclick=()=>h(!0),s.onclick=t=>{t&&t.target===s&&h(!1)},c.appendChild(d),c.appendChild(u),i.appendChild(a),i.appendChild(c),s.appendChild(i),document.body.appendChild(s),x=s,window.setTimeout(()=>{i.classList.add("show")},10)}),_))}function $(){const t=new Error("NEED_LOGIN");return t.needLogin=!0,t}function O(t){const e=t?String(t):"";return e?e.includes("token 无效")?"登录已过期，请重新登录，登录成功后将自动继续。":e:""}function B(t){if(b)return;if(!Jt||!Jt.currentRoute)return;const e=Jt.currentRoute.path;if("/login"===e)return;b=!0;const s=Jt.currentRoute.fullPath||"/";M(O(t)).then(t=>{if(t)return Jt.replace({path:"/login",query:{redirect:s}}).catch(()=>{});b=!1}).finally(()=>{window.setTimeout(()=>{b=!1},300)})}function A(t){B(O(t))}function N(){const t=localStorage.getItem("token")||localStorage.getItem("satoken"),e={};return t&&(e.satoken=t,e.Authorization=`Bearer ${t}`),e}async function H(t,e=[],s,i){const a=w.defaults.baseURL||"",n=`${String(a).replace(/\/$/,"")}/bookkeep/finance/chat/stream`,r=await fetch(n,{method:"POST",headers:{"Content-Type":"application/json",...N()},body:JSON.stringify({userQuestion:t,history:e}),signal:i});if(401===r.status||403===r.status)throw A("该功能需要先登录，登录成功后将自动继续。"),$();if(!r.ok){const t=await r.text().catch(()=>"");if(t&&t.includes("token 无效"))throw A(t),$();throw new Error(t||`请求失败(${r.status})`)}if(!r.body){const t=await r.text();return"function"===typeof s&&t&&s(t),t}const o=r.body.getReader(),l=new TextDecoder("utf-8");let c="",d="",u=!1,h=!0;while(h){const{value:t,done:e}=await o.read();if(e){h=!1;break}c+=l.decode(t,{stream:!0});const i=c.split(/\r?\n/);c=i.pop()||"";for(const a of i)if(a&&a.startsWith("data:")){const t=a.slice(5).replace(/^\s/,"");if("[DONE]"===t){u=!0;break}if(!t)continue;d+=t,"function"===typeof s&&s(t);continue}if(u)break}if(!u&&c){const t=c.split(/\r?\n/);for(const e of t){if(!e)continue;if(!e.startsWith("data:"))continue;const t=e.slice(5).replace(/^\s/,"");t&&"[DONE]"!==t&&(d+=t,"function"===typeof s&&s(t))}}return d}function E(t){const e={};return t&&(e.sessionId=t),w.post("/bookkeep/finance/chat/human",e)}function R(t){const e={};return t&&(e.sessionId=t),w.post("/bookkeep/finance/chat/exit-human",e)}function D(){return w.post("/bookkeep/finance/chat/sessions")}function L(){return w.post("/bookkeep/finance/chat/new")}function P(t){return w.post("/bookkeep/finance/chat/messages",{sessionId:t})}function U(t){return w.post("/bookkeep/finance/chat/messages/human",{sessionId:t})}function z(t="HUMAN"){return w.post("/bookkeep/finance/chat/human/list",{status:t})}function V(t){return w.post("/bookkeep/finance/chat/delete",{sessionId:t})}function q(t){return w.post("/bookkeep/finance/chat/read",{messageId:t})}function J(t){const e=new FormData;return e.append("file",t),w.post("/bookkeep/finance/invoice/analyze",e,{headers:{"Content-Type":"multipart/form-data"}})}function j(t,e){return w.post("/bookkeep/finance/invoice/confirm",{fileToken:t,confirmedType:e})}function F(){const t=w&&w.defaults&&w.defaults.baseURL?String(w.defaults.baseURL):"";return t||("undefined"!==typeof window&&window.location&&window.location.origin?window.location.origin:"")}function W(t,e={}){const s=F();if(!s)return"";let i;try{i=new URL(s)}catch(o){try{i=new URL(s,"undefined"!==typeof window?window.location.origin:void 0)}catch(l){return""}}const a="https:"===i.protocol?"wss:":"ws:",n=`${a}//${i.host}`,r=new URL(String(t||"").startsWith("/")?t:`/${t}`,n);return Object.keys(e||{}).forEach(t=>{const s=e[t];null!==s&&"undefined"!==typeof s&&""!==s&&r.searchParams.set(t,String(s))}),r.toString()}function K(t,e){return W("/bookkeep/ws/human/chat",{sessionId:t,token:e})}function G(t,e={}){const s=e&&e.token?e.token:localStorage.getItem("token")||localStorage.getItem("satoken")||"",i=K(t,s);if(!i)throw new Error("WebSocket URL 构建失败");const a=new WebSocket(i);return a.onopen=t=>{e&&"function"===typeof e.onOpen&&e.onOpen(t)},a.onclose=t=>{e&&"function"===typeof e.onClose&&e.onClose(t)},a.onerror=t=>{e&&"function"===typeof e.onError&&e.onError(t)},a.onmessage=t=>{const s=t&&"string"===typeof t.data?t.data:"";if("PONG"!==s&&(e&&"function"===typeof e.onRawMessage&&e.onRawMessage(s),s))try{const t=JSON.parse(s);e&&"function"===typeof e.onMessage&&e.onMessage(t)}catch(i){e&&"function"===typeof e.onParseError&&e.onParseError(i)}},a}function Q(t){return w.get(`/bookkeep/notification/stats/${t}`)}function Z(t,e={}){return w.get(`/bookkeep/notification/list/${t}`,{params:e})}function Y(t){return w.post(`/bookkeep/notification/read-all/${t}`)}function X(t){return w.post(`/bookkeep/notification/config/risk/check/${t}`)}w.interceptors.request.use(t=>{const e=localStorage.getItem("token")||localStorage.getItem("satoken"),s=t&&t.url?String(t.url):"";s.includes("/api/user/login")||s.includes("bookkeep/api/user/login")||s.includes("/bookkeep/api/user/login");return t.headers||(t.headers={}),e?t.headers.satoken=e:"undefined"!==typeof t.headers.satoken&&delete t.headers.satoken,e?t.headers.Authorization=`Bearer ${e}`:"undefined"!==typeof t.headers.Authorization&&delete t.headers.Authorization,t},t=>Promise.reject(t)),w.interceptors.response.use(t=>{const e=t.data;if(200===e.code)return"undefined"!==typeof e.data?e.data:e;const s=e&&(e.msg||e.message)||"";return!e||401!==e.code&&403!==e.code?e&&500===e.code&&s&&(s.includes("token 无效")||s.includes("未能读取到有效 token")||s.includes("未能读取到有效token"))?(A(s),Promise.reject($())):Promise.reject(new Error(s||"请求失败")):(A(s||"该功能需要先登录，登录成功后将自动继续。"),Promise.reject($()))},t=>{const e=t&&t.response?t.response.status:0;return 401===e||403===e?(A("该功能需要先登录，登录成功后将自动继续。"),Promise.reject($())):Promise.reject(t)});var tt=w,et={name:"MessagePage",data(){return{currentTab:"all",tabs:[{key:"all",label:"全部"},{key:"unread",label:"未读"},{key:"risk",label:"风险"},{key:"system",label:"通知"}],items:[],statsData:{unreadCount:0,riskCount:0,totalCount:0},page:1,size:20,loading:!1}},computed:{unreadCount(){return this.statsData.unreadCount},riskCount(){return this.statsData.riskCount},totalCount(){return this.statsData.totalCount},filteredItems(){return"all"===this.currentTab?this.items:"unread"===this.currentTab?this.items.filter(t=>!t.read):"risk"===this.currentTab?this.items.filter(t=>"RISK"===t.type):"system"===this.currentTab?this.items.filter(t=>"NOTICE"===t.type):this.items},userId(){const t=localStorage.getItem("user");if(t)try{const e=JSON.parse(t);return e.id||e.userId}catch(e){console.error("解析用户信息失败",e)}return null}},mounted(){this.loadData()},methods:{async loadData(){this.userId?await Promise.all([this.loadStats(),this.loadMessages()]):console.error("未找到用户ID")},async loadStats(){try{const t=await Q(this.userId);this.statsData={unreadCount:t.unreadCount||0,riskCount:t.riskCount||0,totalCount:t.totalCount||0}}catch(t){console.error("加载统计数据失败",t)}},async loadMessages(){if(!this.loading){this.loading=!0;try{let t="ALL";"unread"===this.currentTab?t="UNREAD":"risk"===this.currentTab?t="RISK":"system"===this.currentTab&&(t="NOTICE");const e=await Z(this.userId,{page:this.page,size:this.size,type:t});this.items=(e.records||[]).map(t=>this.mapNotificationItem(t))}catch(t){console.error("加载消息列表失败",t)}finally{this.loading=!1}}},mapNotificationItem(t){const e={URGENT:{level:"high",levelText:"紧急"},NORMAL:{level:"mid",levelText:"提醒"},INFO:{level:"low",levelText:"通知"}},s=e[t.level]||{level:"low",levelText:"通知"};return{id:t.id,level:s.level,levelText:s.levelText,title:t.title||"系统通知",desc:t.content||"",time:this.formatTime(t.createTime),read:1===t.isRead,type:t.type}},formatTime(t){if(!t)return"";const e=new Date(t),s=new Date,i=s-e;if(i<6e4)return"刚刚";if(i<36e5)return`${Math.floor(i/6e4)}分钟前`;if(e.toDateString()===s.toDateString())return`今天 ${String(e.getHours()).padStart(2,"0")}:${String(e.getMinutes()).padStart(2,"0")}`;const a=new Date(s);return a.setDate(a.getDate()-1),e.toDateString()===a.toDateString()?"昨天":i<6048e5?`${Math.floor(i/864e5)}天前`:`${e.getMonth()+1}/${e.getDate()}`},openMessage(t){t.read=!0,window.alert(`${t.title}\n\n${t.desc}`),this.loadStats()},async markAllRead(){if(this.userId)try{await Y(this.userId),this.items=this.items.map(t=>({...t,read:!0})),await this.loadStats()}catch(t){console.error("标记已读失败",t),alert("操作失败，请重试")}}},watch:{currentTab(){this.page=1,this.loadMessages()}}},st=et,it=(0,l.A)(st,C,y,!1,null,"cd60ed6c",null),at=it.exports,nt=function(){var t=this,e=t._self._c;return e("div",{staticClass:"mine"},[e("div",{staticClass:"hero"},[t._m(0),e("div",{staticClass:"user-info",on:{click:t.goToLogin}},[e("div",{staticClass:"avatar"},[e("svg",{attrs:{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"1.5"}},[e("path",{attrs:{d:"M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"}}),e("circle",{attrs:{cx:"12",cy:"7",r:"4"}})])]),e("div",{staticClass:"user-text"},[e("div",{staticClass:"user-name"},[t._v(t._s(t.userName))]),e("div",{staticClass:"user-account"},[t._v(t._s(t.accountMasked))])]),e("svg",{staticClass:"chevron",attrs:{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"}},[e("path",{attrs:{d:"M9 18l6-6-6-6"}})])]),e("div",{staticClass:"enterprise",on:{click:function(e){return t.openFeature("企业详情")}}},[e("div",{staticClass:"enterprise-main"},[e("div",{staticClass:"enterprise-icon"},[e("svg",{attrs:{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"1.5"}},[e("path",{attrs:{d:"M3 21h18"}}),e("path",{attrs:{d:"M5 21V7l8-4v18"}}),e("path",{attrs:{d:"M19 21V11l-6-4"}}),e("path",{attrs:{d:"M9 9v.01M9 12v.01M9 15v.01M9 18v.01"}})])]),e("div",{staticClass:"enterprise-text"},[e("div",{staticClass:"enterprise-name"},[t._v(t._s(t.enterpriseName))]),e("div",{staticClass:"enterprise-status"},[e("span",{staticClass:"dot",class:t.enterpriseVerified?"verified":"pending"}),t._v(" "+t._s(t.enterpriseVerified?"已认证":"待认证")+" ")])])]),e("button",{staticClass:"add-enterprise",on:{click:function(e){return e.stopPropagation(),t.openFeature("添加企业")}}},[e("svg",{attrs:{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"}},[e("path",{attrs:{d:"M12 5v14M5 12h14"}})])])])]),e("div",{staticClass:"card"},[t._m(1),e("div",{staticClass:"func-grid"},[e("div",{staticClass:"func-item",on:{click:function(e){return t.$router.push("/consult")}}},[e("div",{staticClass:"func-icon"},[e("svg",{attrs:{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"1.5"}},[e("path",{attrs:{d:"M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"}})])]),e("span",[t._v("AI 助手")])]),e("div",{staticClass:"func-item",on:{click:t.triggerRiskCheck}},[e("div",{staticClass:"func-icon",class:{scanning:t.riskChecking}},[t.riskChecking?e("svg",{staticClass:"spin-icon",attrs:{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"}},[e("path",{attrs:{d:"M21 12a9 9 0 1 1-6.219-8.56"}})]):e("svg",{attrs:{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"1.5"}},[e("path",{attrs:{d:"M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"}})])]),e("span",[t._v(t._s(t.riskChecking?"检测中":"风险监测"))])]),e("div",{staticClass:"func-item",on:{click:function(e){return t.openFeature("票据管理")}}},[e("div",{staticClass:"func-icon"},[e("svg",{attrs:{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"1.5"}},[e("path",{attrs:{d:"M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"}}),e("polyline",{attrs:{points:"14 2 14 8 20 8"}})])]),e("span",[t._v("票据管理")])]),e("div",{staticClass:"func-item",on:{click:t.goToAllApps}},[e("div",{staticClass:"func-icon more"},[e("svg",{attrs:{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"1.5"}},[e("rect",{attrs:{x:"3",y:"3",width:"7",height:"7",rx:"1"}}),e("rect",{attrs:{x:"14",y:"3",width:"7",height:"7",rx:"1"}}),e("rect",{attrs:{x:"3",y:"14",width:"7",height:"7",rx:"1"}}),e("rect",{attrs:{x:"14",y:"14",width:"7",height:"7",rx:"1"}})])]),e("span",[t._v("全部应用")])])])]),e("div",{staticClass:"card"},[t._m(2),e("div",{staticClass:"menu-list"},[e("div",{staticClass:"menu-row",on:{click:function(e){return t.openFeature("账户安全")}}},[e("div",{staticClass:"menu-icon"},[e("svg",{attrs:{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"1.5"}},[e("path",{attrs:{d:"M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"}})])]),e("span",{staticClass:"menu-label"},[t._v("账户安全")]),e("svg",{staticClass:"chevron",attrs:{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"}},[e("path",{attrs:{d:"M9 18l6-6-6-6"}})])]),e("div",{staticClass:"menu-row",on:{click:function(e){return t.openFeature("消息通知")}}},[e("div",{staticClass:"menu-icon"},[e("svg",{attrs:{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"1.5"}},[e("path",{attrs:{d:"M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"}}),e("path",{attrs:{d:"M13.73 21a2 2 0 0 1-3.46 0"}})])]),e("span",{staticClass:"menu-label"},[t._v("消息通知")]),e("span",{staticClass:"red-dot"},[t._v("3")]),e("svg",{staticClass:"chevron",attrs:{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"}},[e("path",{attrs:{d:"M9 18l6-6-6-6"}})])]),e("div",{staticClass:"menu-row",on:{click:function(e){return t.openFeature("帮助与反馈")}}},[e("div",{staticClass:"menu-icon"},[e("svg",{attrs:{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"1.5"}},[e("circle",{attrs:{cx:"12",cy:"12",r:"10"}}),e("path",{attrs:{d:"M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"}}),e("line",{attrs:{x1:"12",y1:"17",x2:"12.01",y2:"17"}})])]),e("span",{staticClass:"menu-label"},[t._v("帮助与反馈")]),e("svg",{staticClass:"chevron",attrs:{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"}},[e("path",{attrs:{d:"M9 18l6-6-6-6"}})])]),e("div",{staticClass:"menu-row",on:{click:function(e){return t.openFeature("关于我们")}}},[e("div",{staticClass:"menu-icon"},[e("svg",{attrs:{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"1.5"}},[e("circle",{attrs:{cx:"12",cy:"12",r:"10"}}),e("line",{attrs:{x1:"12",y1:"16",x2:"12",y2:"12"}}),e("line",{attrs:{x1:"12",y1:"8",x2:"12.01",y2:"8"}})])]),e("span",{staticClass:"menu-label"},[t._v("关于我们")]),e("svg",{staticClass:"chevron",attrs:{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"}},[e("path",{attrs:{d:"M9 18l6-6-6-6"}})])]),e("div",{staticClass:"menu-row",on:{click:function(e){return t.openFeature("设置")}}},[e("div",{staticClass:"menu-icon"},[e("svg",{attrs:{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"1.5"}},[e("circle",{attrs:{cx:"12",cy:"12",r:"3"}}),e("path",{attrs:{d:"M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"}})])]),e("span",{staticClass:"menu-label"},[t._v("设置")]),e("svg",{staticClass:"chevron",attrs:{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"}},[e("path",{attrs:{d:"M9 18l6-6-6-6"}})])])])]),e("button",{staticClass:"logout",on:{click:function(e){return t.openFeature("退出登录")}}},[t._v("退出登录")])])},rt=[function(){var t=this,e=t._self._c;return e("div",{staticClass:"hero-bg"},[e("div",{staticClass:"glow glow-1"}),e("div",{staticClass:"glow glow-2"}),e("div",{staticClass:"glow glow-3"}),e("div",{staticClass:"noise"})])},function(){var t=this,e=t._self._c;return e("div",{staticClass:"card-header"},[e("span",{staticClass:"card-title"},[t._v("常用功能")])])},function(){var t=this,e=t._self._c;return e("div",{staticClass:"card-header"},[e("span",{staticClass:"card-title"},[t._v("服务与设置")])])}],ot={name:"MinePage",data(){return{userName:"用户名",accountMasked:"187****7153",enterpriseName:"雅信通安",enterpriseVerified:!1,riskChecking:!1}},methods:{goToAllApps(){this.$router.replace("/apps")},goToLogin(){this.$router.push("/login")},openFeature(t){window.alert(`${t} 功能开发中`)},async triggerRiskCheck(){if(this.riskChecking)return;const t=localStorage.getItem("user");let e=null;if(t)try{const s=JSON.parse(t);e=s.id||s.userId}catch(s){}if(e){this.riskChecking=!0;try{await X(e),this.showRiskResult("success","风险检测完成，暂未发现异常")}catch(s){const t=s&&s.message?s.message:"检测失败";if(s&&s.needLogin)return;this.showRiskResult("error",t)}finally{this.riskChecking=!1}}else this.showRiskResult("error","请先登录")},showRiskResult(t,e){const s=document.createElement("div");s.className="risk-result-mask";const i=document.createElement("div");i.className="risk-result-card";const a=document.createElement("div");a.className=`risk-result-icon ${t}`,a.innerHTML="success"===t?'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>':'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>';const n=document.createElement("div");n.className="risk-result-text",n.textContent=e;const r=document.createElement("button");if(r.className="risk-result-btn",r.textContent="知道了",r.onclick=()=>{i.classList.remove("show"),setTimeout(()=>{s.parentNode&&s.parentNode.removeChild(s)},200)},i.appendChild(a),i.appendChild(n),i.appendChild(r),s.appendChild(i),document.body.appendChild(s),!document.getElementById("risk-result-styles")){const t=document.createElement("style");t.id="risk-result-styles",t.textContent="\n          .risk-result-mask{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(15,23,42,.5);z-index:9999;backdrop-filter:blur(8px);}\n          .risk-result-card{width:min(300px,calc(100vw - 48px));background:#fff;border-radius:20px;padding:32px 24px;text-align:center;transform:scale(.9);opacity:0;transition:all .25s cubic-bezier(.4,0,.2,1);}\n          .risk-result-card.show{transform:scale(1);opacity:1;}\n          .risk-result-icon{width:64px;height:64px;margin:0 auto 16px;border-radius:50%;display:flex;align-items:center;justify-content:center;}\n          .risk-result-icon.success{background:linear-gradient(135deg,rgba(34,197,94,.15),rgba(22,163,74,.1));color:#16a34a;}\n          .risk-result-icon.error{background:linear-gradient(135deg,rgba(239,68,68,.15),rgba(220,38,38,.1));color:#dc2626;}\n          .risk-result-icon svg{width:32px;height:32px;}\n          .risk-result-text{font-size:15px;font-weight:600;color:#1e293b;line-height:1.5;margin-bottom:24px;}\n          .risk-result-btn{width:100%;height:44px;border:none;border-radius:12px;background:linear-gradient(135deg,#3b82f6,#2563eb);color:#fff;font-size:14px;font-weight:600;cursor:pointer;}\n          .risk-result-btn:active{opacity:.9;}\n        ",document.head.appendChild(t)}setTimeout(()=>i.classList.add("show"),10)}}},lt=ot,ct=(0,l.A)(lt,nt,rt,!1,null,"9d3aa75c",null),dt=ct.exports,ut=function(){var t=this,e=t._self._c;return e("div",{staticClass:"consult"},[t.drawerOpen?e("div",{staticClass:"drawer-mask",on:{click:function(e){t.drawerOpen=!1}}}):t._e(),e("div",{staticClass:"drawer",class:{open:t.drawerOpen}},[e("div",{staticClass:"drawer-header"},[e("span",[t._v("历史对话")]),e("button",{staticClass:"drawer-close",on:{click:function(e){t.drawerOpen=!1}}},[e("svg",{attrs:{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"}},[e("path",{attrs:{d:"M18 6L6 18M6 6l12 12"}})])])]),e("div",{staticClass:"drawer-content"},[t._l(t.chatHistory,function(s,i){return e("div",{key:s.id||i,staticClass:"history-item",class:{active:s.id===t.currentSessionId},on:{click:function(e){return t.loadChat(i)}}},[e("svg",{attrs:{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"1.5"}},[e("path",{attrs:{d:"M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"}})]),e("div",{staticClass:"history-text"},[e("div",{staticClass:"history-title"},[t._v(t._s(s.title))]),e("div",{staticClass:"history-time"},[t._v(t._s(s.time))])]),e("button",{staticClass:"delete-btn",on:{click:function(e){return t.removeChat(i,e)}}},[e("svg",{attrs:{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"}},[e("path",{attrs:{d:"M18 6L6 18M6 6l12 12"}})])])])}),t.chatHistory.length?t._e():e("div",{staticClass:"empty-history"},[t._v("暂无历史对话")])],2),e("div",{staticClass:"drawer-footer"},[e("button",{staticClass:"new-chat-btn",on:{click:t.startNewChat}},[e("svg",{attrs:{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"}},[e("path",{attrs:{d:"M12 5v14M5 12h14"}})]),t._v(" 新建对话 ")])])]),e("div",{staticClass:"topbar"},[e("button",{staticClass:"menu-btn",on:{click:function(e){t.drawerOpen=!0}}},[e("svg",{attrs:{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"}},[e("path",{attrs:{d:"M3 12h18M3 6h18M3 18h18"}})])]),e("div",{staticClass:"enterprise-chip",on:{click:t.switchEnterprise}},[e("div",{staticClass:"enterprise-dot"}),e("span",[t._v(t._s(t.currentEnterprise))]),e("svg",{attrs:{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"}},[e("path",{attrs:{d:"M6 9l6 6 6-6"}})])]),e("button",{staticClass:"new-btn",on:{click:t.startNewChat}},[e("svg",{attrs:{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"}},[e("path",{attrs:{d:"M12 5v14M5 12h14"}})])])]),e("div",{ref:"chatArea",staticClass:"chat-area"},[0===t.messages.length?e("div",{staticClass:"welcome"},[e("div",{staticClass:"welcome-icon"},[e("svg",{attrs:{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"1.2"}},[e("circle",{attrs:{cx:"12",cy:"12",r:"10"}}),e("path",{attrs:{d:"M8 14s1.5 2 4 2 4-2 4-2"}}),e("line",{attrs:{x1:"9",y1:"9",x2:"9.01",y2:"9"}}),e("line",{attrs:{x1:"15",y1:"9",x2:"15.01",y2:"9"}})])]),e("h1",{staticClass:"welcome-title"},[t._v("你好，我是财务AI助手")]),e("p",{staticClass:"welcome-desc"},[t._v("有什么财务问题都可以问我")]),e("div",{staticClass:"suggest-grid"},t._l(t.suggestQuestions,function(s,i){return e("button",{key:i,staticClass:"suggest-card",on:{click:function(e){return t.quickAsk(s.text)}}},[e("div",{staticClass:"suggest-icon"},["tax"===s.icon?e("svg",{attrs:{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"1.5"}},[e("path",{attrs:{d:"M9 5H7a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-2"}}),e("rect",{attrs:{x:"9",y:"3",width:"6",height:"4",rx:"1"}})]):"chart"===s.icon?e("svg",{attrs:{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"1.5"}},[e("path",{attrs:{d:"M3 3v18h18"}}),e("path",{attrs:{d:"M7 16l4-4 4 4 5-6"}})]):"alert"===s.icon?e("svg",{attrs:{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"1.5"}},[e("path",{attrs:{d:"M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"}}),e("line",{attrs:{x1:"12",y1:"9",x2:"12",y2:"13"}}),e("line",{attrs:{x1:"12",y1:"17",x2:"12.01",y2:"17"}})]):e("svg",{attrs:{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"1.5"}},[e("circle",{attrs:{cx:"12",cy:"12",r:"10"}}),e("path",{attrs:{d:"M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"}}),e("line",{attrs:{x1:"12",y1:"17",x2:"12.01",y2:"17"}})])]),e("span",[t._v(t._s(s.text))])])}),0)]):e("div",{staticClass:"messages"},t._l(t.messages,function(s,i){return e("div",{key:"msg-"+i+"-"+t.refreshCounter,staticClass:"message",class:s.role},[e("div",{staticClass:"message-inner"},["assistant"===s.role?e("div",{staticClass:"message-avatar"},[e("svg",{attrs:{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"1.5"}},[e("circle",{attrs:{cx:"12",cy:"12",r:"10"}}),e("path",{attrs:{d:"M8 14s1.5 2 4 2 4-2 4-2"}}),e("line",{attrs:{x1:"9",y1:"9",x2:"9.01",y2:"9"}}),e("line",{attrs:{x1:"15",y1:"9",x2:"15.01",y2:"9"}})])]):t._e(),e("div",{staticClass:"message-content"},["assistant"===s.role?e("div",{staticClass:"message-text markdown-body"},[t.loading&&i===t.messages.length-1&&!s.text?e("div",{staticClass:"typing"},[e("span"),e("span"),e("span")]):e("div",{domProps:{innerHTML:t._s(s.renderedHtml||t.renderMarkdown(s.text))}}),s.text?e("button",{staticClass:"copy-btn",on:{click:function(e){return t.copyMessage(s.text)}}},[e("svg",{attrs:{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"}},[e("rect",{attrs:{x:"9",y:"9",width:"13",height:"13",rx:"2",ry:"2"}}),e("path",{attrs:{d:"M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"}})])]):t._e()]):e("div",{staticClass:"message-text"},[t._v(t._s(s.text))])])])])}),0)]),e("div",{staticClass:"input-section"},[e("div",{staticClass:"input-actions"},[e("button",{staticClass:"action-btn",attrs:{type:"button"},on:{click:t.goHumanSupport}},[t._v("转人工")]),e("button",{staticClass:"action-btn",attrs:{type:"button"},on:{click:t.goInvoiceReimburse}},[t._v("开票申请")])]),e("div",{staticClass:"input-container"},[e("button",{staticClass:"add-btn",on:{click:t.triggerUpload}},[e("svg",{attrs:{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"}},[e("path",{attrs:{d:"M12 5v14M5 12h14"}})])]),e("input",{ref:"cameraInput",staticStyle:{display:"none"},attrs:{type:"file",accept:"image/*",capture:"environment"},on:{change:t.handleFileUpload}}),e("input",{ref:"albumInput",staticStyle:{display:"none"},attrs:{type:"file",accept:"image/*"},on:{change:t.handleFileUpload}}),e("input",{ref:"invoiceInput",staticStyle:{display:"none"},attrs:{type:"file",accept:"image/*,.pdf"},on:{change:t.handleFileUpload}}),e("textarea",{directives:[{name:"model",rawName:"v-model",value:t.draft,expression:"draft"}],ref:"inputEl",staticClass:"input-field",attrs:{placeholder:"输入您的问题...",rows:"1"},domProps:{value:t.draft},on:{keydown:function(e){return!e.type.indexOf("key")&&t._k(e.keyCode,"enter",13,e.key,"Enter")||e.ctrlKey||e.shiftKey||e.altKey||e.metaKey?null:(e.preventDefault(),t.handleEnter.apply(null,arguments))},input:[function(e){e.target.composing||(t.draft=e.target.value)},t.autoResize]}}),t.loading?e("button",{staticClass:"stop-btn",on:{click:t.stopGeneration}},[e("svg",{attrs:{viewBox:"0 0 24 24",fill:"currentColor"}},[e("rect",{attrs:{x:"6",y:"6",width:"12",height:"12",rx:"2"}})])]):e("button",{staticClass:"send-btn",attrs:{disabled:!t.draft.trim()},on:{click:t.send}},[e("svg",{attrs:{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"}},[e("path",{attrs:{d:"M22 2L11 13"}}),e("path",{attrs:{d:"M22 2L15 22L11 13L2 9L22 2Z"}})])])])]),t.showModal?e("div",{staticClass:"modal-mask",on:{click:function(e){if(e.target!==e.currentTarget)return null;t.showModal=!1}}},[e("div",{staticClass:"modal"},[e("div",{staticClass:"modal-title"},[t._v("识别结果")]),t.invoiceResult?e("div",{staticClass:"modal-body"},[e("div",{staticClass:"result-row"},[e("span",{staticClass:"label"},[t._v("发票类型")]),e("span",{staticClass:"value"},[t._v(t._s(t.invoiceResult.invoiceType))])]),e("div",{staticClass:"result-row"},[e("span",{staticClass:"label"},[t._v("业务属性")]),e("span",{staticClass:"value"},[e("select",{directives:[{name:"model",rawName:"v-model",value:t.selectedBusinessType,expression:"selectedBusinessType"}],staticClass:"type-select",on:{change:function(e){var s=Array.prototype.filter.call(e.target.options,function(t){return t.selected}).map(function(t){var e="_value"in t?t._value:t.value;return e});t.selectedBusinessType=e.target.multiple?s:s[0]}}},t._l(t.businessTypeOptions,function(s){return e("option",{key:s,domProps:{value:s}},[t._v(t._s(s))])}),0)])]),e("div",{staticClass:"core-info"},[e("div",{staticClass:"core-label"},[t._v("核心信息")]),e("div",{staticClass:"core-text"},[t._v(t._s(t.invoiceResult.coreInfo))])]),e("div",{staticClass:"suggestion-box"},[t._v(" "+t._s(t.invoiceResult.financeSuggestion)+" ")])]):t._e(),e("button",{staticClass:"btn-close",on:{click:function(e){t.showModal=!1}}},[t._v("关闭")]),e("button",{staticClass:"btn-confirm",attrs:{disabled:t.confirming},on:{click:t.handleConfirm}},[t._v(" "+t._s(t.confirming?"处理中...":"确认入账")+" ")])])]):t._e(),t.showUploadSheet?e("div",{staticClass:"sheet-mask",on:{click:function(e){if(e.target!==e.currentTarget)return null;t.showUploadSheet=!1}}},[e("div",{staticClass:"sheet"},[e("button",{staticClass:"sheet-item",attrs:{type:"button"},on:{click:function(e){return t.chooseUpload("camera")}}},[t._v("现场拍照")]),e("button",{staticClass:"sheet-item",attrs:{type:"button"},on:{click:function(e){return t.chooseUpload("album")}}},[t._v("本地相册")]),e("button",{staticClass:"sheet-item",attrs:{type:"button"},on:{click:function(e){return t.chooseUpload("invoice")}}},[t._v("发票文件")]),e("button",{staticClass:"sheet-cancel",attrs:{type:"button"},on:{click:function(e){t.showUploadSheet=!1}}},[t._v("取消")])])]):t._e()])},ht=[],pt=s(23),mt={name:"ConsultPage",data(){return{drawerOpen:!1,currentEnterprise:"雅信通安",currentSessionId:null,draft:"",loading:!1,messages:[],chatHistory:[],suggestQuestions:[{icon:"tax",text:"企业所得税如何计算？"},{icon:"chart",text:"如何分析财务报表？"},{icon:"alert",text:"常见财务风险有哪些？"},{icon:"help",text:"零申报需要注意什么？"}],showModal:!1,invoiceResult:null,fileToken:"",confirming:!1,showUploadSheet:!1,selectedBusinessType:"",businessTypeOptions:["进项","销项","固定资产","工资","银行"],abortController:null,refreshCounter:0}},mounted(){this.restoreSessionState(),this.initAiEntryState();const t=sessionStorage.getItem("consultDraft");t&&(this.draft=t,sessionStorage.removeItem("consultDraft"))},beforeDestroy(){this.persistAiState()},watch:{drawerOpen(t){t&&this.loadSessions()}},methods:{stripSystemHints(t){const e=Array.isArray(t)?t:[];return 0===e.length?e:e.filter(t=>{const e=t&&"string"===typeof t.text?t.text.trim():"";return!e||!e.includes("用户请求转人工服务")&&!e.includes("已退出人工服务")})},restoreSessionState(){try{const t=sessionStorage.getItem("aiChatState");if(!t)return;const e=JSON.parse(t);if(Date.now()-e.timestamp>3e5)return void sessionStorage.removeItem("aiChatState");e.sessionId&&(this.currentSessionId=e.sessionId),e.messages&&Array.isArray(e.messages)&&(this.messages=this.stripSystemHints(e.messages).map(t=>{const e={...t};return"assistant"===e.role&&e.text&&(e.renderedHtml=this.renderMarkdown(e.text)),e}),this.refreshCounter++),sessionStorage.removeItem("aiChatState"),this.$nextTick(this.scrollToBottom)}catch(t){console.error("恢复会话状态失败",t),sessionStorage.removeItem("aiChatState")}},initAiEntryState(){let t="";try{const e="undefined"!==typeof performance&&performance.getEntriesByType?performance.getEntriesByType("navigation"):[];t=e&&e[0]&&e[0].type?String(e[0].type):""}catch(i){t=""}let e="";try{e=sessionStorage.getItem("pendingAiChat")||""}catch(i){e=""}if("reload"===t&&!e){try{sessionStorage.removeItem("aiChatState"),sessionStorage.removeItem("resumeAiOnce")}catch(i){}return}let s=!1;try{s="1"===sessionStorage.getItem("resumeAiOnce")}catch(i){s=!1}if(e||s){if(this.restoreAiState(),s)try{sessionStorage.removeItem("resumeAiOnce")}catch(i){}this.tryResumePendingAiChat()}},restoreAiState(){try{const t=sessionStorage.getItem("aiChatState");if(!t)return;const e=JSON.parse(t);e&&Array.isArray(e.messages)&&(this.messages=this.stripSystemHints(e.messages).map(t=>{const e={...t};return"assistant"===e.role&&e.text&&(e.renderedHtml=this.renderMarkdown(e.text)),e}),this.refreshCounter++),!e||"number"!==typeof e.currentSessionId&&"string"!==typeof e.currentSessionId||(this.currentSessionId=e.currentSessionId)}catch(t){}},persistAiState(){try{const t={messages:this.stripSystemHints(this.messages),currentSessionId:this.currentSessionId};sessionStorage.setItem("aiChatState",JSON.stringify(t))}catch(t){}},async tryResumePendingAiChat(){const t="需要登录后继续…",e=localStorage.getItem("token")||localStorage.getItem("satoken");if(!e)return;if(this.loading)return;let s,i="";try{i=sessionStorage.getItem("pendingAiChat")||""}catch(r){i=""}if(!i)return;try{s=JSON.parse(i)}catch(r){return}if(!s||!s.question||!Array.isArray(s.history))return;const a=Number(s.assistantIndex);if(Number.isNaN(a)||a<0)return;if(!this.messages||this.messages.length<=a)return;const n=this.messages[a];if(n&&"assistant"===n.role&&("string"!==typeof n.text&&(n.text=""),!n.text||n.text===t)){n.text===t&&(n.text=""),n.renderedHtml&&this.$set(n,"renderedHtml",""),this.loading=!0,this.abortController=new AbortController;try{await H(s.question,s.history,t=>{n.text+=t,this.$nextTick(this.scrollToBottom)},this.abortController.signal),this.$set(n,"renderedHtml",this.renderMarkdown(n.text)),sessionStorage.removeItem("pendingAiChat"),this.persistAiState()}catch(o){if(o&&o.needLogin)return;const t=this.messages[this.messages.length-1];t&&"assistant"===t.role&&!t.text&&(t.text="抱歉，请求失败："+(o&&o.message?o.message:"网络错误，请稍后重试"))}finally{this.loading=!1,this.abortController=null,this.$nextTick(this.scrollToBottom)}}},async loadSessions(){try{const e=await D();let s=[];try{const t=localStorage.getItem("humanChatSessionIds")||"[]",e=JSON.parse(t);Array.isArray(e)&&(s=e.map(t=>Number(t)).filter(t=>!Number.isNaN(t)&&t>0))}catch(t){s=[]}this.chatHistory=(e||[]).filter(t=>!s.includes(Number(t.id))).map(t=>({id:t.id,title:t.title||"新对话",time:this.formatTime(t.createTime||t.updatedAt)}))}catch(t){console.error("加载会话列表失败",t)}},formatTime(t){if(!t)return"";const e=new Date(t),s=new Date,i=s-e;return i<864e5?"今天":i<1728e5?"昨天":`${e.getMonth()+1}/${e.getDate()}`},switchEnterprise(){window.alert("切换企业功能开发中")},async goHumanSupport(){const t=localStorage.getItem("token")||localStorage.getItem("satoken");if(!t){const t=await M("转人工服务需要先登录，登录成功后将自动继续。");return void(t&&this.$router.push({path:"/login",query:{redirect:"/human-support"}}))}try{const t={sessionId:this.currentSessionId,messages:this.messages,timestamp:Date.now()};sessionStorage.setItem("aiChatState",JSON.stringify(t))}catch(i){console.error("保存会话状态失败",i)}const e=localStorage.getItem("humanChatSessionId"),s=this.currentSessionId||e||"";this.$router.push({path:"/human-support",query:{...s?{sessionId:s}:{},redirect:this.$route&&this.$route.fullPath?this.$route.fullPath:"/consult"}})},goInvoiceReimburse(){this.$router.push("/invoice-reimburse")},async startNewChat(){const t=localStorage.getItem("token")||localStorage.getItem("satoken");if(!t){const t=await M("新建会话需要先登录，登录成功后可以创建新的对话。");return void(t&&this.$router.push({path:"/login",query:{redirect:this.$route.fullPath}}))}try{const t=await L();this.currentSessionId=t.id,this.messages=[],this.drawerOpen=!1,this.loadSessions()}catch(e){if(e&&e.needLogin)return;this.messages=[],this.currentSessionId=null,this.drawerOpen=!1}},async loadChat(t){const e=this.chatHistory[t];if(e){this.currentSessionId=e.id,this.drawerOpen=!1;try{const t=await P(e.id);this.messages=this.stripSystemHints((t||[]).map(t=>{const e={role:"user"===t.role?"user":"assistant",text:t.content};return"assistant"===e.role&&(e.renderedHtml=this.renderMarkdown(e.text)),e})),this.$nextTick(this.scrollToBottom)}catch(s){alert("加载失败："+(s.message||"请重试"))}}},async removeChat(t,e){e.stopPropagation();const s=this.chatHistory[t];if(s&&confirm("确定删除该对话？"))try{await V(s.id),this.chatHistory.splice(t,1),this.currentSessionId===s.id&&(this.messages=[],this.currentSessionId=null)}catch(e){alert("删除失败")}},quickAsk(t){this.draft=t,this.send()},autoResize(){const t=this.$refs.inputEl;t&&(t.style.height="auto",t.style.height=Math.min(t.scrollHeight,120)+"px")},triggerUpload(){this.showUploadSheet=!0},chooseUpload(t){this.showUploadSheet=!1,this.$nextTick(()=>{const e="camera"===t?"cameraInput":"album"===t?"albumInput":"invoiceInput",s=this.$refs[e];s&&s.click&&s.click()})},async handleFileUpload(t){const e=t.target.files[0];if(e){try{const t=await J(e);this.invoiceResult=t,this.fileToken=t.fileToken;const s=t&&t.businessType?String(t.businessType):"";this.selectedBusinessType=s||this.businessTypeOptions[0]||"",s&&!this.businessTypeOptions.includes(s)&&(this.businessTypeOptions=[s,...this.businessTypeOptions]),this.showModal=!0}catch(s){alert("识别失败："+(s.message||"请重试"))}t.target.value=""}},async handleConfirm(){this.confirming=!0;try{await j(this.fileToken,this.selectedBusinessType||this.invoiceResult&&this.invoiceResult.businessType),alert("处理成功"),this.showModal=!1}catch(t){alert("处理失败："+(t.message||"请重试"))}this.confirming=!1},async send(){if(!this.draft.trim())return;try{await D()}catch(s){if(s&&s.needLogin)return void sessionStorage.setItem("consultDraft",this.draft)}if(this.loading&&this.stopGeneration(),!this.currentSessionId)try{const t=await L();this.currentSessionId=t.id,console.log("自动创建新会话，sessionId:",this.currentSessionId)}catch(s){if(console.error("创建新会话失败",s),s&&s.needLogin)return;return void alert("创建会话失败："+(s.message||"请重试"))}const t=this.draft.trim();this.draft="",this.$nextTick(()=>{this.$refs.inputEl&&(this.$refs.inputEl.style.height="auto")});const e=this.messages.map(t=>({role:t.role,content:t.text}));this.messages.push({role:"user",text:t}),this.loading=!0,this.$nextTick(this.scrollToBottom),this.abortController=new AbortController;try{const s={role:"assistant",text:""};this.messages.push(s),this.$nextTick(this.scrollToBottom),await H(t,e,t=>{s.text+=t,this.$nextTick(this.scrollToBottom)},this.abortController.signal),this.$set(s,"renderedHtml",this.renderMarkdown(s.text)),this.refreshCounter++,this.$nextTick(this.scrollToBottom),this.currentSessionId&&await this.reloadCurrentSession()}catch(i){if(i&&i.needLogin){const i=this.messages[this.messages.length-1];i&&"assistant"===i.role&&!i.text&&(i.text="需要登录后继续…");try{const s={question:t,history:e,assistantIndex:this.messages.length-1};sessionStorage.setItem("pendingAiChat",JSON.stringify(s)),this.persistAiState()}catch(s){}return}if("AbortError"===i.name)return;const a=this.messages[this.messages.length-1];a&&"assistant"===a.role&&!a.text?a.text="抱歉，请求失败："+(i.message||"网络错误，请稍后重试"):this.messages.push({role:"assistant",text:"抱歉，请求失败："+(i.message||"网络错误，请稍后重试")})}finally{this.loading=!1,this.abortController=null,this.$nextTick(this.scrollToBottom)}},async reloadCurrentSession(){try{const t=await P(this.currentSessionId);this.messages=this.stripSystemHints((t||[]).map(t=>{const e={role:"user"===t.role?"user":"assistant",text:t.content};return"assistant"===e.role&&(e.renderedHtml=this.renderMarkdown(e.text)),e})),this.refreshCounter++,this.$nextTick(this.scrollToBottom)}catch(t){console.error("重新加载会话失败",t)}},stopGeneration(){this.abortController&&(this.abortController.abort(),this.abortController=null),this.loading=!1},handleEnter(){this.loading?(this.stopGeneration(),this.$nextTick(()=>{this.draft.trim()&&this.send()})):this.send()},scrollToBottom(){const t=this.$refs.chatArea;t&&(t.scrollTop=t.scrollHeight)},renderMarkdown(t){if(!t)return"";t=this.convertStructuredDataToTable(t);let e=(0,pt.xI)(t,{breaks:!0});return e=e.replace(/<table>/g,'<div class="table-wrapper"><table>'),e=e.replace(/<\/table>/g,"</table></div>"),e},convertStructuredDataToTable(t){const e=t.split("\n");let s=0;for(const r of e)if(r.includes("|")&&r.split("|").length>=3){if(s++,s>=2)return this.fixPipeTable(t)}else r.trim()&&(s=0);const i=/发票号[：:]\s*\d+.*?发票代码[：:]\s*\d+.*?开票日期[：:]/s;if(i.test(t))return this.parseInvoiceDataToTable(t);const a=/^[\u4e00-\u9fa5]+[：:]\s*.+$/gm,n=t.match(a);return n&&n.length>=5?this.parseKeyValueToTable(t):t},fixPipeTable(t){const e=t.split("\n"),s=[];let i=!1,a=!1;for(let n=0;n<e.length;n++){const t=e[n],r=t.trim(),o=(r.match(/\|/g)||[]).length,l=o>=2&&r.includes("|");if(l){if(/^\|[\s\-:|]+\|$/.test(r))continue;i||(i=!0,a=!1);let t=r;if(t.startsWith("|")||(t="|"+t),t.endsWith("|")||(t+="|"),s.push(t),!a){const e=t.split("|").filter(t=>t.trim()),i=e.map(()=>"---");s.push("|"+i.join("|")+"|"),a=!0}}else i&&(i=!1,a=!1),s.push(t)}return s.join("\n")},parseInvoiceDataToTable(t){const e=/发票号[：:]\s*(\d+).*?发票代码[：:]\s*(\d+).*?开票日期[：:]\s*([\d-]+).*?购买方[：:]\s*([^，,]+).*?销售方[：:]\s*([^，,]+).*?金额[：:]\s*([\d.]+).*?税额[：:]\s*([\d.]+).*?价税合计[：:]\s*([\d.]+).*?状态[：:]\s*([^。.]+)/gs,s=[];let i;while(null!==(i=e.exec(t)))s.push({invoiceNo:i[1],invoiceCode:i[2],date:i[3],buyer:i[4].trim(),seller:i[5].trim(),amount:i[6],tax:i[7],total:i[8],status:i[9].trim()});if(0===s.length)return t;let a="\n\n| 发票号 | 发票代码 | 开票日期 | 购买方 | 销售方 | 金额 | 税额 | 价税合计 | 状态 |\n";a+="|--------|----------|----------|--------|--------|------|------|----------|------|\n",s.forEach(t=>{a+=`| ${t.invoiceNo} | ${t.invoiceCode} | ${t.date} | ${t.buyer} | ${t.seller} | ${t.amount} | ${t.tax} | ${t.total} | ${t.status} |\n`});const n=t.substring(0,t.indexOf("发票号")),r=t.substring(t.lastIndexOf("状态")+10);return n+a+"\n\n"+r},parseKeyValueToTable(t){const e=t.split("\n").filter(t=>t.trim()),s=[];if(e.forEach(t=>{const e=t.match(/^([\u4e00-\u9fa5]+)[：:]\s*(.+)$/);e&&s.push({key:e[1],value:e[2].trim()})}),s.length<5)return t;let i="\n\n| 项目 | 内容 |\n|------|------|\n";return s.forEach(t=>{i+=`| ${t.key} | ${t.value} |\n`}),i+"\n\n"},copyMessage(t){t&&(navigator.clipboard&&navigator.clipboard.writeText?navigator.clipboard.writeText(t).then(()=>{this.showCopyToast()}).catch(()=>{this.fallbackCopy(t)}):this.fallbackCopy(t))},fallbackCopy(t){const e=document.createElement("textarea");e.value=t,e.style.position="fixed",e.style.opacity="0",document.body.appendChild(e),e.select();try{document.execCommand("copy"),this.showCopyToast()}catch(s){alert("复制失败")}document.body.removeChild(e)},showCopyToast(){const t=document.createElement("div");t.className="copy-toast",t.textContent="已复制",document.body.appendChild(t),setTimeout(()=>{t.classList.add("show")},10),setTimeout(()=>{t.classList.remove("show"),setTimeout(()=>document.body.removeChild(t),300)},1500)}}},gt=mt,vt=(0,l.A)(gt,ut,ht,!1,null,"54f3b02d",null),ft=vt.exports,Ct=function(){var t=this,e=t._self._c;return e("div",{staticClass:"human-support"},[e("div",{staticClass:"topbar"},[e("button",{staticClass:"back-btn",attrs:{type:"button"},on:{click:t.goBack}},[e("svg",{attrs:{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"}},[e("path",{attrs:{d:"M15 18l-6-6 6-6"}})])]),e("div",{staticClass:"title-wrap"},[e("div",{staticClass:"title"},[t._v("人工在线咨询")]),e("div",{staticClass:"sub"},[e("span",{staticClass:"status-dot",class:t.status}),"online"===t.status?e("span",[t._v(t._s(t.agentName)+" 在线")]):e("span",[t._v("排队中（前面 "+t._s(t.queueAhead)+" 人）")])])]),e("button",{staticClass:"reply-btn",attrs:{type:"button"},on:{click:t.openReplyPage}},[t._v("回复")]),e("button",{staticClass:"end-btn",attrs:{type:"button"},on:{click:t.endSession}},[t._v("结束")])]),e("div",{ref:"chatArea",staticClass:"chat-area"},[0===t.messages.length?e("div",{staticClass:"welcome"}):e("div",{staticClass:"messages"},[t._l(t.messages,function(s,i){return e("div",{key:i,staticClass:"message",class:s.role},[e("div",{staticClass:"message-inner"},["agent"===s.role?e("div",{staticClass:"message-avatar"},[t._v("人")]):t._e(),e("div",{staticClass:"message-content"},[e("div",{staticClass:"message-text"},[t._v(t._s(s.text))]),e("div",{staticClass:"message-meta"},[e("span",[t._v(t._s(s.time))]),"user"===s.role?e("span",{staticClass:"read-status",class:{read:s.isRead}},[t._v(" "+t._s(s.isRead?"已读":"未读")+" ")]):t._e()])])])])}),t.sending?e("div",{staticClass:"message agent"},[t._m(0)]):t._e()],2)]),e("div",{staticClass:"input-section"},[e("div",{staticClass:"input-container"},[e("textarea",{directives:[{name:"model",rawName:"v-model",value:t.draft,expression:"draft"}],ref:"inputEl",staticClass:"input-field",attrs:{placeholder:"输入您要咨询的问题...",rows:"1"},domProps:{value:t.draft},on:{keydown:function(e){return!e.type.indexOf("key")&&t._k(e.keyCode,"enter",13,e.key,"Enter")||e.ctrlKey||e.shiftKey||e.altKey||e.metaKey?null:(e.preventDefault(),t.send.apply(null,arguments))},input:[function(e){e.target.composing||(t.draft=e.target.value)},t.autoResize]}}),e("button",{staticClass:"send-btn",attrs:{type:"button",disabled:!t.draft.trim()||t.sending},on:{click:t.send}},[e("svg",{attrs:{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"}},[e("path",{attrs:{d:"M22 2L11 13"}}),e("path",{attrs:{d:"M22 2L15 22L11 13L2 9L22 2Z"}})])])])])])},yt=[function(){var t=this,e=t._self._c;return e("div",{staticClass:"message-inner"},[e("div",{staticClass:"message-avatar"},[t._v("人")]),e("div",{staticClass:"message-content"},[e("div",{staticClass:"typing"},[e("span"),e("span"),e("span")]),e("div",{staticClass:"message-meta"},[t._v("正在回复…")])])])}],kt=(s(7642),s(8004),s(3853),s(5876),s(2475),s(5024),s(1698),{name:"HumanSupportPage",data(){return{status:"online",agentName:"小雅",queueAhead:2,draft:"",sending:!1,messages:[],pendingUserEchoCounts:{},handoffDone:!1,sessionId:null,websocket:null,wsConnected:!1,onlineHeartbeat:null}},computed:{statusText(){return"online"===this.status?"在线":"排队"}},mounted(){this.restoreHumanChatState(),this.requestHandoff(),window.addEventListener("storage",this.onStorageChange),window.addEventListener("beforeunload",this.clearOnlineStatus)},beforeDestroy(){this.clearOnlineStatus(),window.removeEventListener("storage",this.onStorageChange),window.removeEventListener("beforeunload",this.clearOnlineStatus),this.closeWebSocket()},methods:{restoreHumanChatState(){try{const t=sessionStorage.getItem("humanChatState");if(!t)return;const e=JSON.parse(t);if(Date.now()-e.timestamp>3e5)return void sessionStorage.removeItem("humanChatState");e.sessionId&&(this.sessionId=e.sessionId),e.messages&&Array.isArray(e.messages)&&(this.messages=e.messages),sessionStorage.removeItem("humanChatState"),this.$nextTick(this.scrollToBottom)}catch(t){console.error("恢复人工客服会话状态失败",t),sessionStorage.removeItem("humanChatState")}},recordHumanSessionId(t){const e=Number(t);if(!(Number.isNaN(e)||e<=0))try{const t=localStorage.getItem("humanChatSessionIds")||"[]",s=JSON.parse(t),i=Array.isArray(s)?s:[];i.includes(e)||i.push(e),localStorage.setItem("humanChatSessionIds",JSON.stringify(i))}catch(s){}},async requestHandoff(){const t=localStorage.getItem("token")||localStorage.getItem("satoken");if(!t)return void this.$router.push({path:"/login",query:{redirect:this.$route.fullPath||"/consult"}});if(!this.sessionId){const t=localStorage.getItem("humanChatSessionId");console.log("从 localStorage 读取 sessionId:",t);const e=Number(t);t&&!Number.isNaN(e)&&e>0&&(this.sessionId=e,console.log("恢复 sessionId:",this.sessionId))}const e=this.$route&&this.$route.query?this.$route.query.sessionId:null;if(console.log("从路由参数读取 sessionId:",e),!this.sessionId&&e){const t=Number(e);!Number.isNaN(t)&&t>0&&(this.sessionId=t,console.log("使用路由 sessionId:",this.sessionId))}if(this.sessionId){console.log("已有会话，sessionId:",this.sessionId),localStorage.setItem("humanChatSessionId",String(this.sessionId)),this.recordHumanSessionId(this.sessionId),this.handoffDone=!0;let t=!1;try{const e=await U(this.sessionId);console.log("HumanSupport 加载历史消息原始数据:",JSON.stringify(e));const s=this.getUserSentMessageIds(),i=(e||[]).map(t=>{let e="agent";return(s.has(String(t.id))||"user"===t.role)&&(e="user"),{id:t.id,role:e,text:t.content,time:this.formatTime(new Date(t.createTime||Date.now())),isRead:1===t.isRead||!0===t.isRead}});console.log("HumanSupport 转换后消息:",JSON.stringify(i)),i.length>0&&(this.messages=i,t=!0)}catch(s){console.error("加载历史消息失败",s)}return t||0!==this.messages.length||(this.messages=[{role:"agent",text:"已为您接入人工客服。",time:this.formatTime(new Date)}]),this.$nextTick(this.scrollToBottom),void this.initWebSocket()}try{const t=await E(this.sessionId?String(this.sessionId):void 0);t&&"undefined"!==typeof t.id&&null!==t.id?this.sessionId=t.id:t&&"undefined"!==typeof t.sessionId&&null!==t.sessionId&&(this.sessionId=t.sessionId),this.sessionId&&(localStorage.setItem("humanChatSessionId",String(this.sessionId)),this.recordHumanSessionId(this.sessionId)),this.handoffDone=!0;let e=!1;if(this.sessionId)try{const t=await U(this.sessionId),s=(t||[]).map(t=>({role:"user"===t.role?"user":"agent",text:t.content,time:this.formatTime(new Date(t.createTime||Date.now())),isRead:1===t.isRead||!0===t.isRead}));s.length>0&&(this.messages=s,e=!0)}catch(s){console.error("加载历史消息失败",s)}e||(this.messages=[{role:"agent",text:"已为您转接人工客服。人工回复可能有延迟，请稍等。",time:this.formatTime(new Date)}]),this.$nextTick(this.scrollToBottom),this.sessionId&&this.initWebSocket()}catch(s){this.handoffDone=!1,this.messages=[{role:"agent",text:`转人工失败：${s&&s.message||"请求失败"}`,time:this.formatTime(new Date)}]}},initWebSocket(){this.sessionId&&(this.websocket&&(this.websocket.close(),this.websocket=null),this.websocket=G(this.sessionId,{onOpen:()=>{this.wsConnected=!0,this.startOnlineHeartbeat()},onClose:()=>{this.wsConnected=!1},onError:()=>{this.wsConnected=!1},onMessage:t=>{if(t){if("message"===t.type&&t.data){const e=t.data,s=e.role;let i="user"===s?"user":"agent";if("user"===s){const t=String(e.content||""),s=this.pendingUserEchoCounts||{};if(s[t]>0)return s[t]=s[t]-1,s[t]<=0&&delete s[t],this.pendingUserEchoCounts={...s},void(e.id&&this.recordUserSentMessage(e.id));i="agent"}return"agent"===i&&this.messages.forEach(t=>{"user"===t.role&&(t.isRead=!0)}),this.messages.push({role:i,text:e.content,time:this.formatTime(new Date(e.createTime||Date.now())),isRead:!1}),void this.$nextTick(this.scrollToBottom)}"error"===t.type&&(this.messages.push({role:"agent",text:t.message||"消息发送失败",time:this.formatTime(new Date),isRead:!1}),this.$nextTick(this.scrollToBottom))}}}))},closeWebSocket(){this.websocket&&(this.websocket.close(),this.websocket=null),this.wsConnected=!1},setOnlineStatus(){if(this.sessionId)try{localStorage.setItem(`humanChat_user_online_${this.sessionId}`,String(Date.now()))}catch(t){}},startOnlineHeartbeat(){this.stopOnlineHeartbeat(),this.setOnlineStatus(),this.onlineHeartbeat=setInterval(()=>{this.setOnlineStatus()},2e3)},stopOnlineHeartbeat(){this.onlineHeartbeat&&(clearInterval(this.onlineHeartbeat),this.onlineHeartbeat=null)},clearOnlineStatus(){if(this.stopOnlineHeartbeat(),this.sessionId)try{localStorage.removeItem(`humanChat_user_online_${this.sessionId}`)}catch(t){}},isAdminOnline(){if(!this.sessionId)return!1;try{const t=localStorage.getItem(`humanChat_admin_online_${this.sessionId}`);return!!t&&Date.now()-Number(t)<5e3}catch(t){return!1}},onStorageChange(t){if(!this.sessionId)return;const e=`humanChat_admin_online_${this.sessionId}`;t.key===e&&t.newValue&&this.messages.forEach(t=>{"user"!==t.role||t.isRead||(t.isRead=!0)})},getUserSentMessageIds(){try{const t=`humanChat_user_sent_${this.sessionId}`,e=localStorage.getItem(t)||"[]";return new Set(JSON.parse(e))}catch(t){return new Set}},recordUserSentMessage(t){if(t&&this.sessionId)try{const e=`humanChat_user_sent_${this.sessionId}`,s=localStorage.getItem(e)||"[]",i=JSON.parse(s);i.includes(String(t))||(i.push(String(t)),localStorage.setItem(e,JSON.stringify(i)))}catch(e){}},navigateBackToAi(){const t=this.$route&&this.$route.query&&this.$route.query.redirect?String(this.$route.query.redirect):"/consult";this.$router.replace(t).catch(()=>{this.$router.replace("/consult").catch(()=>{})})},async goBack(){try{const t={sessionId:this.sessionId,messages:this.messages,timestamp:Date.now()};sessionStorage.setItem("humanChatState",JSON.stringify(t))}catch(t){console.error("保存人工客服会话状态失败",t)}if(this.sessionId)try{localStorage.setItem("humanChatSessionId",String(this.sessionId))}catch(t){console.error("保存 sessionId 失败",t)}this.closeWebSocket(),this.navigateBackToAi()},async endSession(){if(this.sessionId)try{await R(String(this.sessionId));try{sessionStorage.removeItem("humanChatState"),localStorage.removeItem("humanChatSessionId")}catch(t){console.error("清除会话状态失败",t)}this.closeWebSocket(),this.handoffDone=!1,this.sessionId=null,this.navigateBackToAi()}catch(t){alert("退出失败："+(t.message||"请重试"))}else alert("会话ID不存在")},openReplyPage(){if(!this.sessionId)return void alert("会话ID不存在，请先转接人工。当前 sessionId: "+this.sessionId);console.log("打开回复页面，sessionId:",this.sessionId);const t=localStorage.getItem("token")||localStorage.getItem("satoken")||"",e=this.$router.resolve({path:"/human-reply",query:{sessionId:String(this.sessionId),token:t,autoConnect:"1"}}),s=e&&e.href?`${window.location.origin}${e.href}`:`${window.location.origin}/#/human-reply?sessionId=${this.sessionId}&token=${encodeURIComponent(t)}&autoConnect=1`;console.log("回复页面 URL:",s),window.open(s,"_blank")},toggleStatus(){"online"===this.status?(this.status="queue",this.queueAhead=3):(this.status="online",this.queueAhead=0)},prefill(t){this.draft=t,this.$nextTick(()=>{this.autoResize();const t=this.$refs.inputEl;t&&"function"===typeof t.focus&&t.focus()})},autoResize(){const t=this.$refs.inputEl;t&&(t.style.height="auto",t.style.height=Math.min(t.scrollHeight,120)+"px")},send(){if(!this.draft.trim()||this.sending)return;const t=this.draft.trim();this.draft="",this.$nextTick(()=>{this.$refs.inputEl&&(this.$refs.inputEl.style.height="auto")}),this.messages.forEach(t=>{"agent"===t.role&&(t.isRead=!0)});const e=this.isAdminOnline();this.messages.push({role:"user",text:t,time:this.formatTime(new Date),isRead:e}),this.$nextTick(this.scrollToBottom);const s=this.pendingUserEchoCounts||{};s[t]=(s[t]||0)+1,this.pendingUserEchoCounts={...s},this.websocket&&this.websocket.readyState===WebSocket.OPEN?this.websocket.send(JSON.stringify({content:t})):(this.handoffDone&&this.sessionId&&this.initWebSocket(),this.handoffDone||(this.messages.push({role:"agent",text:"当前尚未成功转接人工，请返回重试或重新登录后再试。",time:this.formatTime(new Date),isRead:!1}),this.$nextTick(this.scrollToBottom)))},formatTime(t){const e=String(t.getHours()).padStart(2,"0"),s=String(t.getMinutes()).padStart(2,"0");return`${e}:${s}`},scrollToBottom(){const t=this.$refs.chatArea;t&&(t.scrollTop=t.scrollHeight)}}}),wt=kt,bt=(0,l.A)(wt,Ct,yt,!1,null,"60eabc5c",null),xt=bt.exports,St=function(){var t=this,e=t._self._c;return e("div",{staticClass:"human-reply"},[t.drawerOpen?e("div",{staticClass:"drawer-mask",on:{click:function(e){t.drawerOpen=!1}}}):t._e(),e("div",{staticClass:"drawer",class:{open:t.drawerOpen}},[e("div",{staticClass:"drawer-header"},[e("span",[t._v("会话列表")]),e("button",{staticClass:"drawer-close",on:{click:function(e){t.drawerOpen=!1}}},[e("svg",{attrs:{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"}},[e("path",{attrs:{d:"M18 6L6 18M6 6l12 12"}})])])]),e("div",{staticClass:"drawer-content"},[t._l(t.humanChatHistory,function(s,i){return e("div",{key:s.id||i,staticClass:"history-item",class:{active:s.id===t.currentSessionId,unread:s.unreadCount>0},on:{click:function(e){return t.loadHumanChat(s)}}},[e("div",{staticClass:"history-avatar"},[e("svg",{attrs:{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"1.5"}},[e("path",{attrs:{d:"M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"}}),e("circle",{attrs:{cx:"12",cy:"7",r:"4"}})])]),e("div",{staticClass:"history-text"},[e("div",{staticClass:"history-title"},[t._v(t._s(s.title||"用户咨询"))]),e("div",{staticClass:"history-preview"},[t._v(t._s(s.lastMessage||"暂无消息"))]),e("div",{staticClass:"history-time"},[t._v(t._s(t.formatSessionTime(s.createTime||s.updatedAt)))])]),s.unreadCount>0?e("span",{staticClass:"unread-badge"},[t._v(t._s(s.unreadCount>99?"99+":s.unreadCount))]):t._e()])}),t.humanChatHistory.length||t.loadingList?t._e():e("div",{staticClass:"empty-history"},[t._v("暂无待处理会话")]),t.loadingList?e("div",{staticClass:"empty-history"},[t._v("加载中...")]):t._e()],2),e("div",{staticClass:"drawer-footer"},[e("button",{staticClass:"refresh-btn",on:{click:t.loadHumanSessions}},[e("svg",{attrs:{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"}},[e("path",{attrs:{d:"M23 4v6h-6"}}),e("path",{attrs:{d:"M1 20v-6h6"}}),e("path",{attrs:{d:"M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"}})]),t._v(" 刷新列表 ")])])]),e("div",{staticClass:"topbar"},[e("button",{staticClass:"menu-btn",attrs:{type:"button"},on:{click:t.openDrawer}},[e("svg",{attrs:{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"}},[e("path",{attrs:{d:"M3 12h18M3 6h18M3 18h18"}})])]),e("div",{staticClass:"title"},[t._v("客服工作台")]),e("div",{staticClass:"status",class:t.wsConnected?"online":"offline"},[t._v(t._s(t.wsConnected?"已连接":"未连接"))])]),e("div",{ref:"chatArea",staticClass:"chat-area"},[t.currentSessionId?0===t.messages.length?e("div",{staticClass:"empty"},[t._v("暂无消息")]):e("div",{staticClass:"messages"},t._l(t.messages,function(s,i){return e("div",{key:i,staticClass:"message",class:s.role},[e("div",{staticClass:"message-inner"},["user"===s.role?e("div",{staticClass:"message-avatar user-avatar"},[e("svg",{attrs:{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"1.5"}},[e("path",{attrs:{d:"M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"}}),e("circle",{attrs:{cx:"12",cy:"7",r:"4"}})])]):"admin"===s.role?e("div",{staticClass:"message-avatar admin-avatar"},[t._v("客")]):t._e(),e("div",{staticClass:"message-content"},[e("div",{staticClass:"message-text"},[t._v(t._s(s.text))]),e("div",{staticClass:"message-meta"},[e("span",[t._v(t._s(s.time))]),"admin"===s.role?e("span",{staticClass:"read-status",class:{read:s.isRead}},[t._v(" "+t._s(s.isRead?"已读":"未读")+" ")]):t._e(),"user"===s.role?e("span",{staticClass:"read-status",class:{read:s.isRead}},[t._v(" "+t._s(s.isRead?"已读":"未读")+" ")]):t._e()])])])])}),0):e("div",{staticClass:"empty-state"},[e("div",{staticClass:"empty-icon"},[e("svg",{attrs:{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"1.5"}},[e("path",{attrs:{d:"M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"}})])]),e("div",{staticClass:"empty-text"},[t._v("请从左侧选择会话")]),e("button",{staticClass:"empty-btn",on:{click:t.openDrawer}},[t._v("打开会话列表")])])]),e("div",{staticClass:"input-section"},[e("div",{staticClass:"input-container"},[e("textarea",{directives:[{name:"model",rawName:"v-model",value:t.draft,expression:"draft"}],ref:"inputEl",staticClass:"input-field",attrs:{placeholder:"输入回复内容...",rows:"1"},domProps:{value:t.draft},on:{keydown:function(e){return!e.type.indexOf("key")&&t._k(e.keyCode,"enter",13,e.key,"Enter")||e.ctrlKey||e.shiftKey||e.altKey||e.metaKey?null:(e.preventDefault(),t.send.apply(null,arguments))},input:[function(e){e.target.composing||(t.draft=e.target.value)},t.autoResize]}}),e("button",{staticClass:"send-btn",attrs:{type:"button",disabled:!t.draft.trim()||!t.wsConnected},on:{click:t.send}},[e("svg",{attrs:{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"}},[e("path",{attrs:{d:"M22 2L11 13"}}),e("path",{attrs:{d:"M22 2L15 22L11 13L2 9L22 2Z"}})])])])])])},_t=[],It={name:"HumanReplyPage",data(){return{currentSessionId:null,token:"",websocket:null,wsConnected:!1,draft:"",messages:[],receivedIds:new Set,pendingAdminEchoCounts:{},drawerOpen:!1,humanChatHistory:[],loadingList:!1,onlineHeartbeat:null}},mounted(){const t=this.$route&&this.$route.query?this.$route.query:{};if(this.token=localStorage.getItem("token")||localStorage.getItem("satoken")||"",t.sessionId){const e=Number(t.sessionId);!Number.isNaN(e)&&e>0&&(this.currentSessionId=e)}this.loadHumanSessions(),this.currentSessionId&&this.$nextTick(()=>{this.loadMessages(),this.connect()}),window.addEventListener("storage",this.onStorageChange),window.addEventListener("beforeunload",this.clearOnlineStatus)},beforeDestroy(){this.clearOnlineStatus(),window.removeEventListener("storage",this.onStorageChange),window.removeEventListener("beforeunload",this.clearOnlineStatus),this.disconnect()},methods:{async openDrawer(){this.drawerOpen=!0,await this.loadHumanSessions()},async loadHumanSessions(){this.loadingList=!0;try{const t=await z("HUMAN");this.humanChatHistory=(t||[]).map(t=>({id:t.id,title:t.title||"用户咨询",lastMessage:t.lastMessage||"",createTime:t.createTime||t.updatedAt,unreadCount:t.unreadCount||0}))}catch(t){console.error("加载人工会话列表失败",t)}finally{this.loadingList=!1}},async loadHumanChat(t){t&&t.id&&(this.clearOnlineStatus(),this.disconnect(),this.currentSessionId=t.id,this.drawerOpen=!1,this.messages=[],this.receivedIds=new Set,await this.loadMessages(),this.connect())},async loadMessages(){if(this.currentSessionId)try{const t=await U(this.currentSessionId);console.log("HumanReply 加载历史消息原始数据:",JSON.stringify(t));const e=this.getAdminSentMessageIds();this.messages=(t||[]).map(t=>{let s="user";return e.has(String(t.id))?s="admin":"admin"!==t.role&&"agent"!==t.role||(s="admin"),{id:t.id,role:s,text:t.content,time:this.formatTime(new Date(t.createTime||Date.now())),isRead:1===t.isRead||!0===t.isRead}}),console.log("HumanReply 转换后消息:",JSON.stringify(this.messages)),this.markMessagesAsRead(),this.$nextTick(this.scrollToBottom)}catch(t){console.error("加载消息失败",t)}},async markMessagesAsRead(){const t=this.messages.filter(t=>"user"===t.role&&!t.isRead&&t.id);for(const s of t)try{await q(s.id),s.isRead=!0}catch(e){console.error("标记已读失败",e)}this.loadHumanSessions()},formatSessionTime(t){if(!t)return"";const e=new Date(t),s=new Date,i=s-e;return i<864e5?"今天":i<1728e5?"昨天":`${e.getMonth()+1}/${e.getDate()}`},formatTime(t){const e=String(t.getHours()).padStart(2,"0"),s=String(t.getMinutes()).padStart(2,"0");return`${e}:${s}`},connect(){if(this.currentSessionId){this.websocket&&this.disconnect();try{this.websocket=G(this.currentSessionId,{token:this.token,onOpen:()=>{this.wsConnected=!0,this.startOnlineHeartbeat()},onClose:()=>{this.wsConnected=!1},onError:()=>{this.wsConnected=!1},onMessage:t=>{if(t){if("message"===t.type&&t.data){const e=t.data;if(e&&"undefined"!==typeof e.id&&null!==e.id){const t=String(e.id);if(this.receivedIds.has(t))return;this.receivedIds.add(t)}const s=e.role,i="user"===s?"user":"admin",a=String(e.content||""),n=this.pendingAdminEchoCounts||{};return n[a]>0?(n[a]=n[a]-1,n[a]<=0&&delete n[a],this.pendingAdminEchoCounts={...n},void(e.id&&this.recordAdminSentMessage(e.id))):("user"===i&&this.messages.forEach(t=>{"admin"===t.role&&(t.isRead=!0)}),this.messages.push({id:e.id,role:i,text:e.content,time:this.formatTime(new Date(e.createTime||Date.now())),isRead:!1}),"user"===i&&e.id&&q(e.id).catch(()=>{}),void this.$nextTick(this.scrollToBottom))}"error"===t.type&&console.error("WebSocket error:",t.message)}}})}catch(t){this.websocket=null,this.wsConnected=!1,window.alert(t&&t.message||"连接失败")}}else window.alert("请先选择会话")},disconnect(){this.websocket&&(this.websocket.close(),this.websocket=null),this.wsConnected=!1},setOnlineStatus(){if(this.currentSessionId)try{localStorage.setItem(`humanChat_admin_online_${this.currentSessionId}`,String(Date.now()))}catch(t){}},startOnlineHeartbeat(){this.stopOnlineHeartbeat(),this.setOnlineStatus(),this.onlineHeartbeat=setInterval(()=>{this.setOnlineStatus()},2e3)},stopOnlineHeartbeat(){this.onlineHeartbeat&&(clearInterval(this.onlineHeartbeat),this.onlineHeartbeat=null)},clearOnlineStatus(){if(this.stopOnlineHeartbeat(),this.currentSessionId)try{localStorage.removeItem(`humanChat_admin_online_${this.currentSessionId}`)}catch(t){}},isUserOnline(){if(!this.currentSessionId)return!1;try{const t=localStorage.getItem(`humanChat_user_online_${this.currentSessionId}`);return!!t&&Date.now()-Number(t)<5e3}catch(t){return!1}},onStorageChange(t){if(!this.currentSessionId)return;const e=`humanChat_user_online_${this.currentSessionId}`;t.key===e&&t.newValue&&this.messages.forEach(t=>{"admin"!==t.role||t.isRead||(t.isRead=!0)})},getAdminSentMessageIds(){try{const t=`humanChat_admin_sent_${this.currentSessionId}`,e=localStorage.getItem(t)||"[]";return new Set(JSON.parse(e))}catch(t){return new Set}},recordAdminSentMessage(t){if(t&&this.currentSessionId)try{const e=`humanChat_admin_sent_${this.currentSessionId}`,s=localStorage.getItem(e)||"[]",i=JSON.parse(s);i.includes(String(t))||(i.push(String(t)),localStorage.setItem(e,JSON.stringify(i)))}catch(e){}},send(){const t=this.draft.trim();if(!t)return;if(!this.wsConnected||!this.websocket)return;this.messages.forEach(t=>{"user"===t.role&&(t.isRead=!0)});const e=this.isUserOnline();this.messages.push({id:null,role:"admin",text:t,time:this.formatTime(new Date),isRead:e});const s=this.pendingAdminEchoCounts||{};s[t]=(s[t]||0)+1,this.pendingAdminEchoCounts={...s},this.websocket.send(JSON.stringify({content:t})),this.draft="",this.$nextTick(()=>{this.$refs.inputEl&&(this.$refs.inputEl.style.height="auto"),this.scrollToBottom()})},autoResize(){const t=this.$refs.inputEl;t&&(t.style.height="auto",t.style.height=Math.min(t.scrollHeight,120)+"px")},scrollToBottom(){const t=this.$refs.chatArea;t&&(t.scrollTop=t.scrollHeight)}}},Tt=It,Mt=(0,l.A)(Tt,St,_t,!1,null,"4cc2daca",null),$t=Mt.exports,Ot=function(){var t=this,e=t._self._c;return e("div",{staticClass:"invoice-page"},[e("header",{staticClass:"header"},[e("button",{staticClass:"back-btn",on:{click:function(e){return t.$router.back()}}},[e("svg",{attrs:{width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"#fff","stroke-width":"2"}},[e("path",{attrs:{d:"M15 18l-6-6 6-6"}})])]),e("h1",{staticClass:"title"},[t._v("开票申请")]),e("div",{staticClass:"header-right"})]),e("div",{staticClass:"func-cards"},[e("div",{staticClass:"func-card",on:{click:t.triggerUpload}},[e("div",{staticClass:"func-text"},[t._v("智能识别")]),e("div",{staticClass:"func-icon blue"},[e("svg",{attrs:{width:"40",height:"40",viewBox:"0 0 24 24",fill:"none",stroke:"#3b82f6","stroke-width":"1.5"}},[e("rect",{attrs:{x:"3",y:"3",width:"7",height:"7",rx:"1"}}),e("rect",{attrs:{x:"14",y:"3",width:"7",height:"7",rx:"1"}}),e("rect",{attrs:{x:"3",y:"14",width:"7",height:"7",rx:"1"}}),e("path",{attrs:{d:"M14 14h7v7h-7z","stroke-dasharray":"2 2"}})])]),e("input",{ref:"fileInput",staticStyle:{display:"none"},attrs:{type:"file",accept:"image/*,.pdf"},on:{change:t.handleFileUpload}})]),e("div",{staticClass:"func-card",on:{click:t.goFillInvoice}},[e("div",{staticClass:"func-text"},[t._v("发票填开")]),e("div",{staticClass:"func-icon green"},[e("svg",{attrs:{width:"40",height:"40",viewBox:"0 0 24 24",fill:"none",stroke:"#22c55e","stroke-width":"1.5"}},[e("path",{attrs:{d:"M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"}}),e("polyline",{attrs:{points:"14 2 14 8 20 8"}}),e("path",{attrs:{d:"M12 18v-6M9 15l3 3 3-3"}})])])])]),t._m(0),e("div",{staticClass:"tab-section"},[e("div",{staticClass:"tabs"},[e("div",{staticClass:"tab",class:{active:"invoice"===t.activeTab},on:{click:function(e){t.activeTab="invoice"}}},[t._v(" 开票记录 "),"invoice"===t.activeTab?e("div",{staticClass:"tab-line"}):t._e()]),e("div",{staticClass:"tab",class:{active:"receipt"===t.activeTab},on:{click:function(e){t.activeTab="receipt"}}},[t._v(" 小票记录 ")])]),t.records.length?e("div",{staticClass:"record-list"},t._l(t.records,function(s){return e("div",{key:s.id,staticClass:"record-item"},[e("div",{staticClass:"record-info"},[e("div",{staticClass:"record-title"},[t._v(t._s(s.buyerName))]),e("div",{staticClass:"record-sub"},[t._v(t._s(s.invoiceNo)+" · "+t._s(s.time))])]),e("div",{staticClass:"record-amount"},[t._v("¥"+t._s(s.amount))])])}),0):e("div",{staticClass:"empty"},[e("div",{staticClass:"empty-text"},[t._v("当前没有开票记录哦～")])])]),t.showModal?e("div",{staticClass:"modal-mask",on:{click:function(e){if(e.target!==e.currentTarget)return null;t.showModal=!1}}},[e("div",{staticClass:"modal"},[e("div",{staticClass:"modal-title"},[t._v("识别结果")]),t.result?e("div",{staticClass:"modal-body"},[e("div",{staticClass:"result-row"},[e("span",{staticClass:"label"},[t._v("发票类型")]),e("span",{staticClass:"value"},[t._v(t._s(t.result.invoiceType))])]),e("div",{staticClass:"result-row"},[e("span",{staticClass:"label"},[t._v("业务属性")]),e("span",{staticClass:"value"},[t._v(t._s(t.result.businessType))])]),e("div",{staticClass:"core-info"},[e("div",{staticClass:"core-label"},[t._v("核心信息")]),e("div",{staticClass:"core-text"},[t._v(t._s(t.result.coreInfo))])]),e("div",{staticClass:"suggestion-box"},[t._v(" "+t._s(t.result.financeSuggestion)+" ")])]):t._e(),e("button",{staticClass:"btn-close",on:{click:function(e){t.showModal=!1}}},[t._v("关闭")]),e("button",{staticClass:"btn-confirm",attrs:{disabled:t.confirming},on:{click:t.handleConfirm}},[t._v(" "+t._s(t.confirming?"处理中...":"确认入账")+" ")])])]):t._e()])},Bt=[function(){var t=this,e=t._self._c;return e("div",{staticClass:"tip-bar"},[e("span",{staticClass:"tip-icon"},[t._v("💡")]),e("span",{staticClass:"tip-text"},[t._v("上传发票图片，AI自动识别信息")])])}],At={name:"InvoiceReimbursePage",data(){return{activeTab:"invoice",records:[],showModal:!1,result:null,fileToken:"",confirmType:"INVOICE_INPUT",confirming:!1}},methods:{triggerUpload(){this.$refs.fileInput.click()},async handleFileUpload(t){const e=t.target.files[0];if(e){try{const t=await J(e);this.result=t,this.fileToken=t.fileToken,this.showModal=!0}catch(s){alert("识别失败："+(s.message||"请重试"))}t.target.value=""}},async handleConfirm(){this.confirming=!0;try{await j(this.fileToken,this.confirmType),alert("处理成功"),this.showModal=!1}catch(t){alert("处理失败："+(t.message||"请重试"))}this.confirming=!1},goFillInvoice(){alert("发票填开功能开发中")}}},Nt=At,Ht=(0,l.A)(Nt,Ot,Bt,!1,null,"5fc6a69c",null),Et=Ht.exports,Rt=function(){var t=this,e=t._self._c;return e("div",{staticClass:"login"},[e("div",{staticClass:"topbar"},[e("button",{staticClass:"back-btn",attrs:{type:"button"},on:{click:t.goBack}},[e("svg",{attrs:{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"}},[e("path",{attrs:{d:"M15 18l-6-6 6-6"}})])]),e("div",{staticClass:"title"},[t._v("用户登录")]),e("div",{staticClass:"spacer"})]),e("div",{staticClass:"page-body"},[e("div",{staticClass:"card"},[e("div",{staticClass:"row"},[e("div",{staticClass:"icon"},[e("svg",{attrs:{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"1.8"}},[e("path",{attrs:{d:"M3 21h18"}}),e("path",{attrs:{d:"M5 21V7l8-4v18"}}),e("path",{attrs:{d:"M19 21V11l-6-4"}})])]),e("div",{staticClass:"row-main"},[t._m(0),e("input",{directives:[{name:"model",rawName:"v-model.trim",value:t.form.username,expression:"form.username",modifiers:{trim:!0}}],staticClass:"input",attrs:{placeholder:"请输入用户名"},domProps:{value:t.form.username},on:{keydown:function(e){return!e.type.indexOf("key")&&t._k(e.keyCode,"enter",13,e.key,"Enter")?null:(e.preventDefault(),t.submit.apply(null,arguments))},input:function(e){e.target.composing||t.$set(t.form,"username",e.target.value.trim())},blur:function(e){return t.$forceUpdate()}}})])])]),e("div",{staticClass:"card"},[e("div",{staticClass:"section-title"},[e("div",{staticClass:"icon"},[e("svg",{attrs:{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"1.8"}},[e("rect",{attrs:{x:"5",y:"3",width:"14",height:"18",rx:"2"}}),e("path",{attrs:{d:"M8 7h8"}}),e("path",{attrs:{d:"M8 11h8"}}),e("path",{attrs:{d:"M8 15h5"}})])]),e("div",{staticClass:"section-text"},[t._v("密码登录")])]),e("div",{staticClass:"field"},[e("div",{staticClass:"field-label"},[t._v("密码")]),e("input",{directives:[{name:"model",rawName:"v-model.trim",value:t.form.password,expression:"form.password",modifiers:{trim:!0}}],staticClass:"input",attrs:{type:"password",placeholder:"请输入密码"},domProps:{value:t.form.password},on:{keydown:function(e){return!e.type.indexOf("key")&&t._k(e.keyCode,"enter",13,e.key,"Enter")?null:(e.preventDefault(),t.submit.apply(null,arguments))},input:function(e){e.target.composing||t.$set(t.form,"password",e.target.value.trim())},blur:function(e){return t.$forceUpdate()}}})])]),e("div",{staticClass:"note"},[t._v(" 工作时间：周一至周五 09:00-18:00（法定节假日除外） ")])]),e("div",{staticClass:"footer"},[e("button",{staticClass:"primary-btn",attrs:{type:"button",disabled:!t.canSubmit},on:{click:t.submit}},[t._v(" 登录 ")])])])},Dt=[function(){var t=this,e=t._self._c;return e("div",{staticClass:"label"},[e("span",[t._v("用户名")]),e("span",{staticClass:"tag"},[t._v("账号登录")])])}];function Lt(t,e){return tt.post("bookkeep/api/user/login",{username:t,password:e})}var Pt={name:"LoginPage",data(){return{form:{username:"",password:""},loading:!1}},computed:{canSubmit(){return this.form.username.trim()&&this.form.password.trim()&&!this.loading}},methods:{goBack(){window.history.length>1?this.$router.back():this.$router.replace("/consult")},async submit(){if(this.canSubmit){this.loading=!0;try{const t=await Lt(this.form.username,this.form.password);t&&t.token&&(localStorage.setItem("token",t.token),localStorage.setItem("satoken",t.token)),t&&t.user&&localStorage.setItem("user",JSON.stringify(t.user));const e=this.$route&&this.$route.query?this.$route.query.redirect:"";e?this.$router.replace(String(e)):this.$router.replace("/mine")}catch(t){window.alert(t&&t.message?t.message:"登录失败")}finally{this.loading=!1}}}}},Ut=Pt,zt=(0,l.A)(Ut,Rt,Dt,!1,null,"2e827b62",null),Vt=zt.exports;i.Ay.use(u.Ay);const qt=u.Ay.prototype.replace;u.Ay.prototype.replace=function(t){return qt.call(this,t).catch(t=>t)};var Jt=new u.Ay({mode:"hash",scrollBehavior(t,e,s){return s||{x:0,y:0}},routes:[{path:"/",redirect:"/consult"},{path:"/home",redirect:"/consult"},{path:"/apps",name:"AppsPage",component:f},{path:"/message",name:"MessagePage",component:at},{path:"/mine",name:"MinePage",component:dt},{path:"/consult",name:"ConsultPage",component:ft},{path:"/human-support",name:"HumanSupportPage",component:xt},{path:"/human-reply",name:"HumanReplyPage",component:$t},{path:"/invoice-reimburse",name:"InvoiceReimbursePage",component:Et},{path:"/login",name:"LoginPage",component:Vt},{path:"/expert",redirect:"/consult"},{path:"/info",redirect:"/message"},{path:"*",redirect:"/consult"}]});i.Ay.config.productionTip=!1,new i.Ay({router:Jt,render:t=>t(d)}).$mount("#app")}},e={};function s(i){var a=e[i];if(void 0!==a)return a.exports;var n=e[i]={exports:{}};return t[i].call(n.exports,n,n.exports,s),n.exports}s.m=t,function(){var t=[];s.O=function(e,i,a,n){if(!i){var r=1/0;for(d=0;d<t.length;d++){i=t[d][0],a=t[d][1],n=t[d][2];for(var o=!0,l=0;l<i.length;l++)(!1&n||r>=n)&&Object.keys(s.O).every(function(t){return s.O[t](i[l])})?i.splice(l--,1):(o=!1,n<r&&(r=n));if(o){t.splice(d--,1);var c=a();void 0!==c&&(e=c)}}return e}n=n||0;for(var d=t.length;d>0&&t[d-1][2]>n;d--)t[d]=t[d-1];t[d]=[i,a,n]}}(),function(){s.d=function(t,e){for(var i in e)s.o(e,i)&&!s.o(t,i)&&Object.defineProperty(t,i,{enumerable:!0,get:e[i]})}}(),function(){s.g=function(){if("object"===typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(t){if("object"===typeof window)return window}}()}(),function(){s.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)}}(),function(){s.r=function(t){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}}(),function(){var t={524:0};s.O.j=function(e){return 0===t[e]};var e=function(e,i){var a,n,r=i[0],o=i[1],l=i[2],c=0;if(r.some(function(e){return 0!==t[e]})){for(a in o)s.o(o,a)&&(s.m[a]=o[a]);if(l)var d=l(s)}for(e&&e(i);c<r.length;c++)n=r[c],s.o(t,n)&&t[n]&&t[n][0](),t[n]=0;return s.O(d)},i=self["webpackChunkdaizhang_app"]=self["webpackChunkdaizhang_app"]||[];i.forEach(e.bind(null,0)),i.push=e.bind(null,i.push.bind(i))}();var i=s.O(void 0,[504],function(){return s(8076)});i=s.O(i)})();
//# sourceMappingURL=app.1d1fe215.js.map